<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>888 é•·ç…§ SDK - å•Ÿå‹•æˆæ¬Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            color: #2c3e50;
        }
        .status.loading {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        .status.success {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        .status.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        .config-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .config-item {
            margin: 15px 0;
        }
        .config-item label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .config-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .config-item small {
            display: block;
            color: #6c757d;
            margin-top: 5px;
            font-size: 12px;
        }
        button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
        }
        .info-box strong {
            color: #1976D2;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” 888 é•·ç…§ SDK</h1>
        <p class="subtitle">SMART on FHIR æˆæ¬Šå•Ÿå‹•</p>
        
        <div class="info-box">
            <strong>ğŸ“‹ æ¨™æº–ç™»å…¥è·¯å¾‘ï¼š</strong><br>
            æ­¥é©Ÿ 1: é–‹å•Ÿ launch.htmlï¼ˆå–å¾—å­˜å–æ¬Šé™çš„ã€Œé‘°åŒ™ã€ï¼‰<br>
            æ­¥é©Ÿ 2: èº«åˆ†é©—è­‰ï¼ˆç³»çµ±ç¢ºèªæ‡‰ç”¨ç¨‹å¼èº«åˆ†èˆ‡æ¬Šé™ç¯„åœï¼‰<br>
            æ­¥é©Ÿ 3: è½‰è·³ index.htmlï¼ˆå¸¶è‘—æ ¸ç™¼çš„é‘°åŒ™(TOKEN)å®‰å…¨é–‹å•Ÿä¸»ç¨‹å¼ï¼‰
        </div>

        <div class="config-section">
            <div class="config-item">
                <label for="issUrl">ISS Server URLï¼ˆè³‡æºæ‰€åœ¨åœ°ï¼‰</label>
                <input type="text" id="issUrl" 
                    value="https://thas.mohw.gov.tw/v/r4/sim/WzlslilslilslkFVVE8iLDASMCwwLCIiLCIILCIÄ°LCIÄ°LCIÄ°LCIÄ°LCIILDAsMSwill0/fhir"
                    placeholder="https://thas.mohw.gov.tw/v/r4/sim/.../fhir">
                <small>è¡›ç¦éƒ¨ FHIR ä¼ºæœå™¨çš„ç¶²å€ï¼Œå‘Šè¨´ç¨‹å¼è¦é€£å¾€å“ªå°é›»è…¦å–å¾—è³‡æ–™</small>
            </div>

            <div class="config-item">
                <label for="authEndpoint">Authorization Endpointï¼ˆæˆæ¬Šç«¯é»ï¼‰</label>
                <input type="text" id="authEndpoint" value="https://thas.mohw.gov.tw/provider-login" placeholder="https://thas.mohw.gov.tw/provider-login">
                <small>THAS æˆæ¬Šé é¢ç«¯é»ï¼ˆProvider ç™»å…¥ï¼‰ï¼Œè‹¥å¯è®€å– SMART é…ç½®æœƒè‡ªå‹•å¸¶å…¥</small>
            </div>

            <div class="config-item">
                <label for="tokenEndpoint">Token Endpointï¼ˆäº¤æ› Token ç«¯é»ï¼‰</label>
                <input type="text" id="tokenEndpoint" value="" placeholder="https://.../fhir/auth/token">
                <small>æˆæ¬Šç¢¼äº¤æ› Access Token çš„ç«¯é»ï¼Œè‹¥å¯è®€å– SMART é…ç½®æœƒè‡ªå‹•å¸¶å…¥</small>
            </div>
            
            <div class="config-item">
                <label for="clientId">Client IDï¼ˆç³»çµ±èº«åˆ†è­‰ï¼‰</label>
                <input type="text" id="clientId" value="my-client-id" placeholder="è«‹è¼¸å…¥æ‚¨åœ¨ THAS è¨»å†Šçš„ Client ID">
                <small><strong>âš ï¸ é‡è¦ï¼š</strong>å¿…é ˆä½¿ç”¨åœ¨ THAS æ²™ç›’ç’°å¢ƒä¸­è¨»å†Šçš„çœŸå¯¦ Client IDï¼Œä¸èƒ½ä½¿ç”¨ "my-client-id"</small>
            </div>
            
            <div class="config-item">
                <label for="scope">Scopeï¼ˆæ¬Šé™ç¯„åœæ¸…å–®ï¼‰</label>
                <input type="text" id="scope" 
                    value="launch/patient patient/*.read patient/*.write openid fhirUser"
                    placeholder="launch/patient patient/*.read openid fhirUser">
                <small>æ˜ç¢ºå®šç¾©é€™æŠŠé‘°åŒ™èƒ½é–‹å“ªäº›é–€ã€å¯ä»¥è®€å–å“ªäº›ç—…äººè³‡æ–™</small>
            </div>
            
            <div class="config-item">
                <label for="redirectUri">Redirect URIï¼ˆå‚³é€é–€ï¼‰</label>
                <input type="text" id="redirectUri" value="./index.html" placeholder="./index.html">
                <small>æ‚¨çš„ä¸»ç¨‹å¼ç¶²å€ï¼Œé€šå¸¸æ˜¯ ./index.htmlã€‚æˆæ¬Šå®Œæˆå¾Œæœƒè‡ªå‹•å°å‘æ­¤é é¢ä¸¦å‚³é Token</small>
            </div>

            <div class="config-item">
                <label for="loginType">Login Typeï¼ˆç™»å…¥é¡å‹ï¼‰</label>
                <input type="text" id="loginType" value="provider" placeholder="provider">
                <small>THAS ç™»å…¥é¡å‹ï¼Œé†«äº‹äººå“¡ä½¿ç”¨ provider</small>
            </div>
        </div>

        <div id="status" class="status">
            æº–å‚™å°±ç·’ï¼Œè«‹è¨­å®šä¸Šæ–¹åƒæ•¸å¾Œé»æ“Šã€Œé–‹å§‹æˆæ¬Šã€æŒ‰éˆ•
        </div>

        <button id="btnLaunch" onclick="handleLaunch()">ğŸš€ é–‹å§‹æˆæ¬Š</button>
    </div>

    <script>
        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è³‡è¨Š
        function showDetailedError(error, authParams) {
            const errorDetails = `
                <div style="margin-top: 15px; padding: 15px; background-color: #fee; border-radius: 5px; border-left: 4px solid #e74c3c;">
                    <strong style="color: #c0392b;">éŒ¯èª¤è©³æƒ…ï¼š</strong><br>
                    <code>${error.message}</code><br><br>
                    <strong>è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š</strong><br>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Client IDï¼š</strong>å¿…é ˆä½¿ç”¨åœ¨ THAS è¨»å†Šçš„çœŸå¯¦ IDï¼Œä¸èƒ½ä½¿ç”¨ "my-client-id"<br>
                            <code>${authParams.clientId}</code></li>
                        <li><strong>Redirect URIï¼š</strong>å¿…é ˆèˆ‡ THAS è¨»å†Šæ™‚è¨­å®šå®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬å”è­°ã€åŸŸåã€è·¯å¾‘ã€ç«¯å£ï¼‰<br>
                            <code>${authParams.redirectUri}</code></li>
                        <li><strong>ISS URLï¼š</strong>ç¢ºèª URL æ­£ç¢ºä¸”å¯è¨ªå•<br>
                            <code>${authParams.iss}</code></li>
                        <li><strong>Scopeï¼š</strong>ç¢ºèªæ¬Šé™ç¯„åœæ­£ç¢º<br>
                            <code>${authParams.scope}</code></li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>å¸¸è¦‹å•é¡Œï¼š</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>å¦‚æœçœ‹åˆ° "invalid_request" éŒ¯èª¤ï¼Œé€šå¸¸æ˜¯ Client ID æˆ– Redirect URI ä¸æ­£ç¢º</li>
                        <li>å¦‚æœçœ‹åˆ° JSON è§£æéŒ¯èª¤ï¼Œå¯èƒ½æ˜¯åƒæ•¸æ ¼å¼å•é¡Œï¼Œè«‹ç¢ºèªæ‰€æœ‰åƒæ•¸éƒ½æ­£ç¢º</li>
                        <li>è«‹ç¢ºèªå·²åœ¨ THAS æ²™ç›’ç’°å¢ƒä¸­è¨»å†Šæ‡‰ç”¨ç¨‹å¼</li>
                    </ul>
                </div>
            `;
            document.getElementById('status').innerHTML += errorDetails;
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showLoading() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="spinner"></div><div>æ­£åœ¨è™•ç†æˆæ¬Šæµç¨‹...</div>';
            statusDiv.className = 'status loading';
        }

        function randomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            const values = new Uint8Array(length);
            window.crypto.getRandomValues(values);
            return Array.from(values, (v) => charset[v % charset.length]).join('');
        }

        function base64UrlEncode(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            bytes.forEach((b) => (binary += String.fromCharCode(b)));
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return crypto.subtle.digest('SHA-256', data);
        }

        async function generatePkce() {
            const codeVerifier = randomString(96);
            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64UrlEncode(hashed);
            return { codeVerifier, codeChallenge };
        }

        function toAbsoluteUrl(input) {
            const currentUrl = new URL(window.location.href);
            const basePath = currentUrl.pathname.substring(0, currentUrl.pathname.lastIndexOf('/') + 1);
            if (input.startsWith('http://') || input.startsWith('https://')) {
                return input;
            }
            if (input.startsWith('./')) {
                return currentUrl.origin + basePath + input.substring(2);
            }
            if (input.startsWith('/')) {
                return currentUrl.origin + input;
            }
            return currentUrl.origin + basePath + input;
        }

        async function resolveSmartConfig(issUrl) {
            try {
                const configUrl = `${issUrl}/.well-known/smart-configuration`;
                const res = await fetch(configUrl);
                if (!res.ok) return null;
                return await res.json();
            } catch (error) {
                console.warn('SMART é…ç½®è®€å–å¤±æ•—:', error);
                return null;
            }
        }

        // è™•ç†å•Ÿå‹•æˆæ¬Š
        async function handleLaunch() {
            try {
                // å–å¾—è¨­å®šå€¼
                const issUrl = document.getElementById('issUrl').value.trim();
                const clientId = document.getElementById('clientId').value.trim();
                const scope = document.getElementById('scope').value.trim();
                let redirectUri = document.getElementById('redirectUri').value.trim();

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!issUrl) {
                    updateStatus('âŒ éŒ¯èª¤ï¼šè«‹è¼¸å…¥ ISS Server URL', 'error');
                    return;
                }

                if (!clientId || clientId === 'my-client-id') {
                    updateStatus('âŒ éŒ¯èª¤ï¼šè«‹è¼¸å…¥åœ¨ THAS è¨»å†Šçš„çœŸå¯¦ Client IDï¼ˆä¸èƒ½ä½¿ç”¨ "my-client-id"ï¼‰', 'error');
                    alert('âš ï¸ é‡è¦æé†’ï¼š\n\næ‚¨å¿…é ˆä½¿ç”¨åœ¨ THAS æ²™ç›’ç’°å¢ƒä¸­è¨»å†Šçš„çœŸå¯¦ Client IDã€‚\n\n"my-client-id" åªæ˜¯ç¯„ä¾‹ï¼Œç„¡æ³•é€šéæˆæ¬Šé©—è­‰ã€‚\n\nè«‹å‰å¾€ THAS è¨»å†Šæ‡‰ç”¨ç¨‹å¼ä¸¦å–å¾—çœŸå¯¦çš„ Client IDã€‚');
                    return;
                }

                if (!scope) {
                    updateStatus('âŒ éŒ¯èª¤ï¼šè«‹è¼¸å…¥ Scope', 'error');
                    return;
                }

                const authEndpointInput = document.getElementById('authEndpoint').value.trim();
                const tokenEndpointInput = document.getElementById('tokenEndpoint').value.trim();
                const loginType = document.getElementById('loginType').value.trim() || 'provider';

                // å¦‚æœæ²’æœ‰è¨­å®š redirectUriï¼Œä½¿ç”¨é è¨­å€¼
                if (!redirectUri) {
                    redirectUri = './index.html';
                    document.getElementById('redirectUri').value = redirectUri;
                }

                // è½‰æ›ç‚ºçµ•å° URL
                redirectUri = toAbsoluteUrl(redirectUri);
                document.getElementById('redirectUri').value = redirectUri;

                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                showLoading();
                document.getElementById('btnLaunch').disabled = true;

                updateStatus('æ­£åœ¨ç”¢ç”Ÿæˆæ¬Šåƒæ•¸èˆ‡ PKCE...', 'loading');

                const smartConfig = await resolveSmartConfig(issUrl);
                const authEndpoint = authEndpointInput || (smartConfig && smartConfig.authorization_endpoint) || 'https://thas.mohw.gov.tw/provider-login';
                const tokenEndpoint = tokenEndpointInput || (smartConfig && smartConfig.token_endpoint) || `${issUrl}/auth/token`;

                document.getElementById('authEndpoint').value = authEndpoint;
                document.getElementById('tokenEndpoint').value = tokenEndpoint;

                const { codeVerifier, codeChallenge } = await generatePkce();
                const state = randomString(24);

                // ä¿å­˜æˆæ¬Šä¸Šä¸‹æ–‡
                sessionStorage.setItem('oauth_state', state);
                sessionStorage.setItem('oauth_code_verifier', codeVerifier);
                sessionStorage.setItem('oauth_iss', issUrl);
                sessionStorage.setItem('oauth_client_id', clientId);
                sessionStorage.setItem('oauth_redirect_uri', redirectUri);
                sessionStorage.setItem('oauth_scope', scope);
                sessionStorage.setItem('oauth_auth_endpoint', authEndpoint);
                sessionStorage.setItem('oauth_token_endpoint', tokenEndpoint);
                sessionStorage.setItem('oauth_login_type', loginType);

                // çµ„åˆæˆæ¬Š URL
                const authUrl = new URL(authEndpoint);
                authUrl.searchParams.set('response_type', 'code');
                authUrl.searchParams.set('client_id', clientId);
                authUrl.searchParams.set('redirect_uri', redirectUri);
                authUrl.searchParams.set('scope', scope);
                authUrl.searchParams.set('state', state);
                authUrl.searchParams.set('code_challenge', codeChallenge);
                authUrl.searchParams.set('code_challenge_method', 'S256');
                authUrl.searchParams.set('aud', issUrl);
                if (loginType) {
                    authUrl.searchParams.set('login_type', loginType);
                }

                console.log('æˆæ¬Š URL:', authUrl.toString());
                updateStatus('æ­£åœ¨å°å‘æˆæ¬Šé é¢ï¼ˆTHAS ç™»å…¥ï¼‰...', 'loading');

                window.location.href = authUrl.toString();

            } catch (error) {
                console.error('æˆæ¬ŠéŒ¯èª¤:', error);
                updateStatus(`âŒ æˆæ¬Šå¤±æ•—: ${error.message}`, 'error');
                document.getElementById('btnLaunch').disabled = false;
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦å·²æœ‰æˆæ¬Šç‹€æ…‹
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // æª¢æŸ¥ URL åƒæ•¸ï¼Œçœ‹æ˜¯å¦æ˜¯å¾æˆæ¬Šé é¢è¿”å›
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                
                if (code && state) {
                    // é€™æ˜¯å¾æˆæ¬Šé é¢è¿”å›ï¼Œæ‡‰è©²å°å‘ index.html
                    updateStatus('âœ“ æˆæ¬Šå®Œæˆï¼Œæ­£åœ¨å°å‘ä¸»ç¨‹å¼...', 'success');
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 1000);
                    return;
                }
                
                // å¦‚æœå·²ç¶“æœ‰ access tokenï¼Œå…è¨±å¿«é€Ÿè·³è½‰
                const existingToken = sessionStorage.getItem('access_token');
                if (existingToken) {
                    updateStatus('âœ“ åµæ¸¬åˆ°å·²å­˜åœ¨çš„æˆæ¬Šç‹€æ…‹ï¼Œæ­£åœ¨å°å‘ä¸»ç¨‹å¼...', 'success');
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 1000);
                }
            } catch (error) {
                // å¦‚æœç„¡æ³•æ¢å¾©ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼ˆé¦–æ¬¡è¨ªå•ï¼‰
                console.log('é¦–æ¬¡è¨ªå•æˆ–éœ€è¦é‡æ–°æˆæ¬Š:', error);
            }
        });
    </script>
</body>
</html>
