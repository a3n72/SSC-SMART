<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Standalone Launch - THAS æ²™ç›’ç’°å¢ƒ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
        }
        .config-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .config-item {
            margin: 10px 0;
        }
        .config-item label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
            color: #555;
        }
        .config-item input {
            width: 600px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .config-item .copy-btn {
            width: auto;
            padding: 8px 15px;
            margin-left: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .config-item .copy-btn:hover {
            background-color: #2980b9;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
        }
        .error {
            background-color: #fee;
            border-left-color: #e74c3c;
        }
        .success {
            background-color: #efe;
            border-left-color: #27ae60;
        }
        .warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #27ae60;
        }
        .btn-primary:hover {
            background-color: #229954;
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        .info {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Provider Standalone Launch - THAS æ²™ç›’ç’°å¢ƒ</h1>
        
        <div class="info">
            <strong>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼š</strong>
            <ul>
                <li>æ­¤é é¢ç¤ºç¯„å¦‚ä½•ä½¿ç”¨ <strong>Provider Standalone Launch</strong> æ¨¡å¼é€£æ¥åˆ° THAS æ²™ç›’ç’°å¢ƒ</li>
                <li>è«‹å…ˆå¾ THAS æ²™ç›’ç’°å¢ƒçš„ SAND-BOX å°è©±æ¡†å–å¾— ISS server URL</li>
                <li>ç¢ºä¿æ‚¨å·²åœ¨ THAS è¨»å†Šæ‡‰ç”¨ç¨‹å¼ä¸¦å–å¾— Client ID</li>
                <li>è¨­å®šæ­£ç¢ºçš„ Redirect URIï¼ˆå¿…é ˆèˆ‡è¨»å†Šæ™‚è¨­å®šçš„ä¸€è‡´ï¼‰</li>
                <li>é»æ“Šã€Œé–‹å§‹ Standalone Launchã€æŒ‰éˆ•å¾Œï¼Œæœƒå°å‘æˆæ¬Šé é¢é€²è¡Œç™»å…¥å’Œç—…äººé¸æ“‡</li>
            </ul>
        </div>

        <h2>âš™ï¸ é€£ç·šè¨­å®š</h2>
        <div class="config-section">
            <div class="config-item">
                <label>ISS Server URL:</label>
                <input type="text" id="issUrl" value="https://thas.mohw.gov.tw/v/r4/sim/WzlslilslilslkFVVE8iLDASMCwwLCIiLCIILCIÄ°LCIÄ°LCIÄ°LCIÄ°LCIILDAsMSwill0/fhir">
                <button class="copy-btn" onclick="copyToClipboard('issUrl')">ğŸ“‹ è¤‡è£½</button>
            </div>
            <div class="config-item">
                <label>Patient Viewer URL:</label>
                <input type="text" id="patientViewerUrl" value="https://thas.mohw.gov.tw/patient-browser/" readonly>
                <button class="copy-btn" onclick="copyToClipboard('patientViewerUrl')">ğŸ“‹ è¤‡è£½</button>
            </div>
            <div class="config-item">
                <label>Client ID:</label>
                <input type="text" id="clientId" value="ltc-888-sdk" placeholder="è«‹è¼¸å…¥æ‚¨åœ¨ THAS è¨»å†Šçš„ Client ID">
            </div>
            <div class="config-item">
                <label>Redirect URI:</label>
                <input type="text" id="redirectUri" value="" placeholder="è‡ªå‹•ä½¿ç”¨ç•¶å‰é é¢ URL">
            </div>
            <div class="config-item">
                <label>Scope:</label>
                <input type="text" id="scope" value="launch/patient openid fhiruser patient/*.read patient/*.write">
            </div>
        </div>

        <div id="status" class="status">
            æº–å‚™å°±ç·’ï¼Œè«‹è¨­å®šä¸Šæ–¹åƒæ•¸å¾Œé»æ“Šã€Œé–‹å§‹ Standalone Launchã€æŒ‰éˆ•
        </div>

        <div>
            <button class="btn-primary" id="btnStandaloneLaunch" onclick="handleStandaloneLaunch()">
                ğŸš€ é–‹å§‹ Standalone Launch
            </button>
            <button id="btnGetPatient" onclick="handleGetPatient()" disabled>ğŸ‘¤ å–å¾—ç—…äººè³‡æ–™</button>
            <button id="btnGetObservations" onclick="handleGetObservations()" disabled>ğŸ“Š è®€å– Observation</button>
            <button id="btnCreateBP" onclick="handleCreateBloodPressure()" disabled>ğŸ’“ å»ºç«‹è¡€å£“è¨˜éŒ„</button>
            <button id="btnLogout" onclick="handleLogout()" disabled>ğŸšª ç™»å‡º</button>
        </div>

        <h2>ğŸ“„ çµæœ</h2>
        <div id="result" style="margin-top: 20px;"></div>
    </div>

    <script type="module">
        import { LTC888Client, mapBloodPressure } from '../src/index.js';

        let client = null;

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        window.copyToClipboard = function(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            document.execCommand('copy');
            alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        };

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // é¡¯ç¤ºçµæœ
        function showResult(data, title = '') {
            const resultDiv = document.getElementById('result');
            const titleHtml = title ? `<h3>${title}</h3>` : '';
            resultDiv.innerHTML = `${titleHtml}<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // Standalone Launch
        window.handleStandaloneLaunch = async function() {
            try {
                updateStatus('æ­£åœ¨åŸ·è¡Œ Standalone Launch...', 'info');
                
                // å–å¾—è¨­å®šå€¼
                const issUrl = document.getElementById('issUrl').value.trim();
                const clientId = document.getElementById('clientId').value.trim();
                const scope = document.getElementById('scope').value.trim();
                let redirectUri = document.getElementById('redirectUri').value.trim();
                
                // å¦‚æœæ²’æœ‰è¨­å®š redirectUriï¼Œä½¿ç”¨ç•¶å‰é é¢ URL
                if (!redirectUri) {
                    redirectUri = window.location.href.split('?')[0];
                    document.getElementById('redirectUri').value = redirectUri;
                }

                if (!issUrl) {
                    updateStatus('éŒ¯èª¤ï¼šè«‹è¼¸å…¥ ISS Server URL', 'error');
                    return;
                }

                if (!clientId) {
                    updateStatus('éŒ¯èª¤ï¼šè«‹è¼¸å…¥ Client ID', 'error');
                    return;
                }

                // ä½¿ç”¨ LTC888Client é€²è¡Œ Standalone Launch
                client = new LTC888Client(issUrl, {
                    clientId: clientId,
                    scope: scope,
                    redirectUri: redirectUri
                });

                await client.initialize();

                updateStatus('âœ“ Standalone Launch æˆåŠŸï¼å·²å–å¾—æˆæ¬Š', 'success');
                document.getElementById('btnGetPatient').disabled = false;
                document.getElementById('btnGetObservations').disabled = false;
                document.getElementById('btnCreateBP').disabled = false;
                document.getElementById('btnLogout').disabled = false;
                
                showResult({ 
                    status: 'success',
                    message: 'Standalone Launch æˆåŠŸå®Œæˆ',
                    issUrl: issUrl,
                    clientId: clientId
                }, 'æˆæ¬ŠæˆåŠŸ');

            } catch (error) {
                updateStatus(`âœ— Standalone Launch å¤±æ•—: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
                showResult({ 
                    error: error.message,
                    stack: error.stack 
                }, 'éŒ¯èª¤è³‡è¨Š');
            }
        };

        // å–å¾—ç—…äººè³‡æ–™
        window.handleGetPatient = async function() {
            try {
                if (!client) {
                    updateStatus('éŒ¯èª¤ï¼šå°šæœªåˆå§‹åŒ– Client', 'error');
                    return;
                }

                updateStatus('æ­£åœ¨è®€å–ç—…äººè³‡æ–™...', 'info');
                const patient = await client.getPatientInfo();
                const patientId = await client.getPatientId();
                
                showResult({
                    patientId: patientId,
                    patient: patient
                }, 'ç—…äººè³‡æ–™');
                
                updateStatus('âœ“ æˆåŠŸå–å¾—ç—…äººè³‡æ–™ï¼', 'success');
            } catch (error) {
                updateStatus(`âœ— è®€å–ç—…äººè³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
                showResult({ error: error.message }, 'éŒ¯èª¤è³‡è¨Š');
            }
        };

        // è®€å– Observation
        window.handleGetObservations = async function() {
            try {
                if (!client) {
                    updateStatus('éŒ¯èª¤ï¼šå°šæœªåˆå§‹åŒ– Client', 'error');
                    return;
                }

                updateStatus('æ­£åœ¨è®€å– Observation...', 'info');
                const observations = await client.getObservation();
                
                showResult(observations, 'Observation åˆ—è¡¨');
                
                const count = observations.entry?.length || 0;
                updateStatus(`âœ“ æˆåŠŸè®€å– ${count} ç­† Observationï¼`, 'success');
            } catch (error) {
                updateStatus(`âœ— è®€å– Observation å¤±æ•—: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
                showResult({ error: error.message }, 'éŒ¯èª¤è³‡è¨Š');
            }
        };

        // å»ºç«‹è¡€å£“è¨˜éŒ„
        window.handleCreateBloodPressure = async function() {
            try {
                if (!client) {
                    updateStatus('éŒ¯èª¤ï¼šå°šæœªåˆå§‹åŒ– Client', 'error');
                    return;
                }

                updateStatus('æ­£åœ¨å»ºç«‹è¡€å£“è¨˜éŒ„...', 'info');
                
                const patientId = await client.getPatientId();
                
                // ä½¿ç”¨ mapper å»ºç«‹è¡€å£“ Observation
                const bloodPressure = mapBloodPressure(
                    120,  // æ”¶ç¸®å£“
                    80,   // èˆ’å¼µå£“
                    patientId,
                    new Date()
                );
                
                const result = await client.createObservation(bloodPressure);
                
                showResult(result, 'å»ºç«‹çš„è¡€å£“ Observation');
                updateStatus('âœ“ æˆåŠŸå»ºç«‹è¡€å£“è¨˜éŒ„ï¼', 'success');
            } catch (error) {
                updateStatus(`âœ— å»ºç«‹è¡€å£“è¨˜éŒ„å¤±æ•—: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
                showResult({ error: error.message }, 'éŒ¯èª¤è³‡è¨Š');
            }
        };

        // ç™»å‡º
        window.handleLogout = async function() {
            try {
                if (client) {
                    await client.logout();
                    client = null;
                }
                updateStatus('å·²ç™»å‡º', 'info');
                document.getElementById('btnGetPatient').disabled = true;
                document.getElementById('btnGetObservations').disabled = true;
                document.getElementById('btnCreateBP').disabled = true;
                document.getElementById('btnLogout').disabled = true;
                document.getElementById('result').innerHTML = '';
            } catch (error) {
                updateStatus(`ç™»å‡ºå¤±æ•—: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
            }
        };

        // é é¢è¼‰å…¥æ™‚å˜—è©¦æ¢å¾©æˆæ¬Šç‹€æ…‹
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const issUrl = document.getElementById('issUrl').value.trim();
                if (!issUrl) return;

                client = new LTC888Client(issUrl);
                const restored = await client.initialize();
                
                if (restored && client.getClient()) {
                    updateStatus('âœ“ å·²æ¢å¾©æˆæ¬Šç‹€æ…‹', 'success');
                    document.getElementById('btnGetPatient').disabled = false;
                    document.getElementById('btnGetObservations').disabled = false;
                    document.getElementById('btnCreateBP').disabled = false;
                    document.getElementById('btnLogout').disabled = false;
                }
            } catch (error) {
                // å¦‚æœç„¡æ³•æ¢å¾©ï¼Œé€™æ˜¯æ­£å¸¸çš„ï¼ˆé¦–æ¬¡è¨ªå•ï¼‰
                console.log('ç„¡æ³•æ¢å¾©æˆæ¬Šç‹€æ…‹ï¼ˆé¦–æ¬¡è¨ªå•æˆ–å·²éæœŸï¼‰');
            }
        });
    </script>
</body>
</html>
