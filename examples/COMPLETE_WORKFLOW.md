# 完整工作流程指南

## 📋 流程概覽

**啟動/登入 → 授權 → 載入 → 查看資料 → 分析 → 匯出**

本指南說明如何使用 888 長照 SDK 完成從啟動到匯出的完整流程。

> 🔐 **技術背景**：本流程基於 SMART on FHIR 標準，使用 OAuth 2.0 + PKCE 機制完成安全授權。詳細技術說明請參考 [SMART on FHIR 完整授權流程](SMART_ON_FHIR_FLOW.md)

## 🚀 步驟說明

### 步驟 1: 啟動/登入 (launch.html)

**目的：** 取得存取權限的「鑰匙」（Access Token）

1. **開啟 launch.html**
   ```
   http://localhost:8000/examples/launch.html
   ```

2. **設定四把鑰匙：**
   - **ISS Server URL（資源所在地）**
     - 從 THAS 沙盒環境的 SAND-BOX 對話框取得
     - 範例：`https://thas.mohw.gov.tw/v/r4/sim/.../fhir`
   
   - **Client ID（系統身分證）**
     - 您在 THAS 註冊的應用程式唯一編號
     - 沒有 Client ID，伺服器會直接拒絕連線請求
   
   - **Scope（權限範圍清單）**
     - 明確定義這把鑰匙能開哪些門、可以讀取哪些病人資料
     - 範例：`launch/patient patient/*.read patient/*.write openid fhirUser`
     - 權限範圍必須在註冊應用程式時事先聲明，不能臨時擴充
   
   - **Redirect URI（傳送門）**
     - 您的主程式網址，通常是 `./index.html`
     - 授權完成後會自動導向此頁面並傳遞 Token

3. **點擊「🚀 開始授權」按鈕**

### 步驟 2: 身分驗證

**目的：** 系統確認您的應用程式身分與權限範圍

1. **自動導向 THAS 授權頁面**
   - 系統會自動開啟 THAS 的登入頁面

2. **登入（Practitioner Login）**
   - 輸入 Practitioner 名稱（例如：Dr. Albertine Qin）
   - 輸入密碼（沙盒環境中任何密碼都可以）
   - 點擊「Login」

3. **選擇病人（Select Patient）**
   - 在病人列表中搜尋並選擇要查看的病人
   - 點擊病人名稱進行選擇

4. **授權同意（Authorize App Launch）**
   - 確認應用程式請求的權限範圍
   - 點擊「Approve」同意授權

### 步驟 3: 載入主程式 (index.html)

**目的：** 帶著核發的鑰匙(TOKEN)安全開啟主程式

1. **自動導向 index.html**
   - 授權完成後，系統會自動導向 `index.html`
   - 帶著 Access Token 和 state 參數

2. **初始化檢查**
   - 系統會檢查是否有授權憑證（state 參數）
   - 如果直接開啟 index.html 而沒有經過 launch.html，會顯示錯誤訊息

3. **載入病人資料**
   - 系統自動載入當前病人的基本資料

## 📊 步驟 4: 查看資料

在主程式頁面中，您可以：

### 4.1 查看病人資料
- 點擊「👤 病人資料」標籤
- 查看：
  - 病人 ID
  - 姓名
  - 性別
  - 年齡
  - 完整 FHIR Patient 資源

### 4.2 查看健康記錄
- 點擊「📊 健康記錄」標籤
- 系統會載入所有 Observation 資源
- 顯示表格包含：
  - 日期時間
  - 類型（血壓、血糖、體重等）
  - 數值
  - 單位
  - 狀態

## 📈 步驟 5: 數據分析

1. **點擊「📈 數據分析」標籤**

2. **查看分析結果：**
   - **血壓趨勢分析**
     - 平均收縮壓
     - 平均舒張壓
     - 最新血壓值
     - 血壓趨勢圖表（使用 Chart.js 繪製）

3. **圖表功能：**
   - 互動式折線圖
   - 顯示收縮壓和舒張壓的變化趨勢
   - 可縮放和查看詳細數據

## 💾 步驟 6: 匯出資料

1. **點擊「💾 匯出資料」標籤**

2. **選擇匯出格式：**
   - **📄 JSON 格式**
     - 匯出完整的 FHIR 資源（Patient + Observations）
     - 適合程式處理和備份
   
   - **📊 CSV 格式**
     - 匯出健康記錄表格
     - 適合 Excel 或其他試算表軟體開啟
   
   - **📑 PDF 報告**（開發中）
     - 生成完整的健康報告文件

3. **下載檔案**
   - 點擊對應的匯出按鈕
   - 檔案會自動下載到您的電腦

## ⚠️ 重要注意事項

### 為什麼不能直接開啟 index.html？

1. **缺少安全憑證**
   - SMART on FHIR 使用類似 SSO 的標準協議
   - 需要隨機的 `state` 參數確保連線安全性和完整性

2. **沒有經過驗證流程**
   - 如果直接開啟 index.html，瀏覽器不會有授權憑證
   - 應用程式會判定為無效或不安全的未授權登入

3. **標準登入路徑**
   - 必須按照：`launch.html → 授權 → index.html` 的順序
   - 這是 SMART on FHIR 的安全機制

### 四把鑰匙的重要性

| 鑰匙 | 說明 | 重要性 |
|------|------|--------|
| **ISS** | 資源所在地（FHIR 伺服器網址） | 告訴程式要連往哪台電腦取得資料 |
| **Client ID** | 系統身分證（應用程式唯一編號） | 沒有 Client ID，伺服器會直接拒絕連線請求 |
| **Scope** | 權限範圍清單 | 明確定義能存取哪些資料，必須在註冊時事先聲明 |
| **Redirect URI** | 傳送門（主程式網址） | 授權完成後導向的位置，必須與註冊時設定一致 |

## 🔄 完整流程圖

```
┌─────────────────┐
│  launch.html    │  ← 步驟 1: 啟動/登入
│  (設定四把鑰匙) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  THAS 授權頁面   │  ← 步驟 2: 身分驗證
│  (登入+選病人)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  index.html     │  ← 步驟 3: 載入主程式
│  (帶 Token)     │
└────────┬────────┘
         │
         ├─→ 步驟 4: 查看資料
         │   ├─ 病人資料
         │   └─ 健康記錄
         │
         ├─→ 步驟 5: 數據分析
         │   └─ 血壓趨勢圖
         │
         └─→ 步驟 6: 匯出資料
             ├─ JSON
             ├─ CSV
             └─ PDF (開發中)
```

## 🛠️ 快速啟動

### 1. 啟動本地伺服器

```bash
# 使用 Python
python -m http.server 8000

# 或使用 Node.js
npx http-server -p 8000
```

### 2. 開啟瀏覽器

```
http://localhost:8000/examples/launch.html
```

### 3. 按照上述步驟操作

## 📝 範例檔案

- **launch.html** - 啟動和授權頁面
- **index.html** - 主程式頁面（查看、分析、匯出）
- **standalone-launch-thas.html** - 進階範例（可自訂所有參數）

## 🆘 常見問題

### Q: 為什麼點擊「開始授權」後沒有反應？
A: 檢查瀏覽器控制台是否有錯誤訊息，確認：
- ISS URL 是否正確
- Client ID 是否已在 THAS 註冊
- Redirect URI 是否與註冊時設定一致

### Q: 授權後無法載入資料？
A: 確認：
- Scope 是否包含必要的權限（如 `patient/*.read`）
- 網路連線是否正常
- Token 是否已過期（需要重新授權）

### Q: 如何選擇不同的病人？
A: 點擊「登出」按鈕，然後重新從 launch.html 開始流程，在步驟 2 中選擇不同的病人。

## 📚 相關資源

- [SMART on FHIR 官方文件](http://docs.smarthealthit.org/)
- [THAS 沙盒環境](https://thas.mohw.gov.tw/)
- [FHIR 官方文件](https://www.hl7.org/fhir/)
- [TW Core IG](https://twcore.mohw.gov.tw/)
