<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾¡æ›²åŒå·¥å…¨äººæ•´åˆç…§è­·SMARTå¹³å° (SSC-SMART)</title>
    <!-- è¼‰å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        .nav {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
            background-color: #f8f9fa;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav button:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }
        .nav button.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        .nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .content-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #ecf0f1;
            font-size: 24px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .info-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .info-label {
            font-weight: bold;
            color: #555;
        }
        .info-value {
            color: #2c3e50;
        }
        .lab-section {
            margin-bottom: 30px;
        }
        .lab-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .data-table thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .data-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-normal {
            background-color: #d4edda;
            color: #155724;
        }
        .status-abnormal {
            background-color: #f8d7da;
            color: #721c24;
        }
        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .alert-box.critical {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .alert-box .alert-icon {
            font-size: 24px;
        }
        .alert-box .alert-content h4 {
            color: #856404;
            margin-bottom: 5px;
        }
        .alert-box.critical .alert-content h4 {
            color: #721c24;
        }
        .alert-box .alert-content p {
            color: #856404;
            font-size: 14px;
        }
        .alert-box.critical .alert-content p {
            color: #721c24;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .score-card.metabolic {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .score-card.cardiovascular {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .score-card.kidney-liver {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .score-value {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .score-label {
            font-size: 16px;
            opacity: 0.9;
        }
        .risk-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .risk-factor-card {
            background: white;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .risk-factor-card .risk-icon {
            font-size: 24px;
            color: #dc3545;
        }
        .risk-factor-card .risk-content h4 {
            color: #721c24;
            margin-bottom: 5px;
        }
        .risk-factor-card .risk-content p {
            color: #555;
            font-size: 14px;
        }
        .metabolic-criteria {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .criteria-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        .criteria-card.abnormal {
            border-color: #dc3545;
            background: #fff5f5;
        }
        .criteria-card.normal {
            border-color: #28a745;
            background: #f0fff4;
        }
        .criteria-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .criteria-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .criteria-reference {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .criteria-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .export-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .export-btn.json {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .export-btn.csv {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        /* è¡€å£“è¶¨å‹¢åœ–è¡¨æ¨£å¼ */
        #section-bp {
            padding: 20px;
        }
        #section-bp .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        #section-bp .chart-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        #section-bp .chart-wrapper {
            position: relative;
            height: 500px;
            min-height: 500px;
        }
        #section-bp canvas {
            max-height: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å¾¡æ›²åŒå·¥å…¨äººæ•´åˆç…§è­·SMARTå¹³å°</h1>
        <div class="subtitle">SSC-SMART</div>
    </div>

    <div class="nav">
        <button id="btnPatient" class="active" onclick="showSection('patient')">
            <span>ğŸ‘¤</span> ç—…äººè³‡æ–™
        </button>
        <button id="btnLab" onclick="showSection('lab')">
            <span>ğŸ”</span> ç”Ÿç†æ•¸æ“š
        </button>
        <button id="btnClinical" onclick="showSection('clinical')">
            <span>ğŸ“Š</span> è‡¨åºŠè©•ä¼°
        </button>
        <button id="btnExport" onclick="showSection('export')">
            <span>ğŸ“„</span> åŒ¯å‡ºå ±å‘Š
        </button>
        <button id="btnManagement" onclick="window.location.href='./metabolic-syndrome-management.html'" style="background: #28a745; color: white;">
            <span>ğŸ“‹</span> ç–¾ç—…ç®¡ç†
        </button>
        <button id="btnBP" onclick="showSection('bp')">
            <span>ğŸ“ˆ</span> è¡€å£“è¶¨å‹¢
        </button>
        <button onclick="logout()" style="margin-left: auto; background: #dc3545; color: white;">
            <span>ğŸšª</span> ç™»å‡º
        </button>
    </div>

    <div class="container">
        <!-- ç—…äººè³‡æ–™å€å¡Š -->
        <div id="section-patient" class="content-section active">
            <h2>ğŸ‘¤ ç—…äººè³‡æ–™</h2>
            <div id="patient-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨è¼‰å…¥ç—…äººè³‡æ–™...</div>
                </div>
            </div>
        </div>

        <!-- ç”Ÿç†æ•¸æ“šå€å¡Š -->
        <div id="section-lab" class="content-section">
            <h2>ğŸ” ç”Ÿç†æ•¸æ“š</h2>
            <div id="lab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨è¼‰å…¥ç”Ÿç†æ•¸æ“š...</div>
                </div>
            </div>
        </div>

        <!-- è‡¨åºŠè©•ä¼°å€å¡Š -->
        <div id="section-clinical" class="content-section">
            <h2>ğŸ“Š è‡¨åºŠè©•ä¼°</h2>
            <div id="clinical-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨è¼‰å…¥è‡¨åºŠè©•ä¼°...</div>
                </div>
            </div>
        </div>

        <!-- è¡€å£“è¶¨å‹¢å€å¡Š -->
        <div id="section-bp" class="content-section">
            <h2>ğŸ“ˆ è¡€å£“è¶¨å‹¢</h2>
            <div id="bp-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨è¼‰å…¥è¡€å£“æ•¸æ“š...</div>
                </div>
            </div>
        </div>

        <!-- åŒ¯å‡ºå ±å‘Šå€å¡Š -->
        <div id="section-export" class="content-section">
            <h2>ğŸ“„ åŒ¯å‡ºå ±å‘Š</h2>
            <div id="export-content">
                <p style="margin-bottom: 20px; color: #555;">é¸æ“‡åŒ¯å‡ºæ ¼å¼ä»¥ä¸‹è¼‰å®Œæ•´çš„å¥åº·å ±å‘Šè³‡æ–™ï¼š</p>
                <div class="export-buttons">
                    <button class="export-btn json" onclick="exportData('json')">
                        <span>ğŸ“„</span> åŒ¯å‡º JSON æ ¼å¼
                    </button>
                    <button class="export-btn csv" onclick="exportData('csv')">
                        <span>ğŸ“Š</span> åŒ¯å‡º CSV æ ¼å¼
                    </button>
                </div>
                <div id="export-result" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ fhirclient CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@2.6.3/build/fhir-client.min.js"></script>
    
    <script>
        // å…¨å±€è®Šæ•¸
        let fhirClient = null;
        let patientData = null;
        let observationsData = null;
        let conditionsData = null;
        let fhirResources = null;
        let accessToken = null;
        let fhirBaseUrl = null;
        let patientId = null;
        let bpChart = null;
        let distributionChart = null;

        // åˆ‡æ›å€å¡Šé¡¯ç¤º - å¿…é ˆåœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šç¾©ï¼Œä¾› HTML onclick èª¿ç”¨
        window.showSection = function(section) {
            // éš±è—æ‰€æœ‰å€å¡Š
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            // é¡¯ç¤ºé¸ä¸­çš„å€å¡Š
            const sectionEl = document.getElementById(`section-${section}`);
            const btnId = `btn${section.charAt(0).toUpperCase() + section.slice(1)}`;
            const btnEl = document.getElementById(btnId);
            
            if (sectionEl) sectionEl.classList.add('active');
            if (btnEl) btnEl.classList.add('active');

            // æ ¹æ“šå€å¡Šè¼‰å…¥å°æ‡‰è³‡æ–™
            if (section === 'patient' && !patientData) {
                loadPatientData();
            } else if (section === 'lab' && !observationsData) {
                loadLabReports();
            } else if (section === 'clinical' && !conditionsData) {
                loadClinicalAssessment();
            } else if (section === 'bp') {
                loadBloodPressureTrend();
            }
        };

        // ç™»å‡º - å¿…é ˆåœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šç¾©
        window.logout = async function() {
            try {
                sessionStorage.clear();
                window.location.href = './launch.html';
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                sessionStorage.clear();
                window.location.href = './launch.html';
            }
        };

        // åŒ¯å‡ºè³‡æ–™ - å¿…é ˆåœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šç¾©
        window.exportData = async function(format) {
            try {
                if (!accessToken || !fhirBaseUrl || !patientId) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }

                // æ”¶é›†æ‰€æœ‰ FHIR è³‡æº
                const patientRes = await authorizedFetch(`${fhirBaseUrl}/Patient/${patientId}`);
                const patient = await patientRes.json();
                
                const obsRes = await authorizedFetch(`${fhirBaseUrl}/Observation?subject=Patient/${patientId}`);
                const observations = await obsRes.json();
                
                const condRes = await authorizedFetch(`${fhirBaseUrl}/Condition?subject=Patient/${patientId}`);
                const conditions = await condRes.json();

                fhirResources = {
                    patient,
                    observations: observations.entry?.map(e => e.resource) || [],
                    conditions: conditions.entry?.map(e => e.resource) || []
                };

                if (format === 'json') {
                    exportJSON(fhirResources);
                } else if (format === 'csv') {
                    exportCSV(fhirResources);
                }
            } catch (error) {
                console.error('åŒ¯å‡ºå¤±æ•—:', error);
                document.getElementById('export-result').innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>åŒ¯å‡ºå¤±æ•—</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        };

        // å–å¾—æˆæ¬Šä¸Šä¸‹æ–‡
        function getAuthContext() {
            return {
                iss: sessionStorage.getItem('oauth_iss'),
                clientId: sessionStorage.getItem('oauth_client_id'),
                redirectUri: sessionStorage.getItem('oauth_redirect_uri'),
                scope: sessionStorage.getItem('oauth_scope'),
                tokenEndpoint: sessionStorage.getItem('oauth_token_endpoint'),
                state: sessionStorage.getItem('oauth_state'),
                codeVerifier: sessionStorage.getItem('oauth_code_verifier')
            };
        }

        // æˆæ¬Šçš„ fetch
        async function authorizedFetch(url, options = {}) {
            if (!accessToken) {
                throw new Error('ç¼ºå°‘ Access Tokenï¼Œè«‹é‡æ–°æˆæ¬Š');
            }
            const headers = {
                Accept: 'application/fhir+json',
                Authorization: `Bearer ${accessToken}`,
                ...(options.headers || {})
            };
            return fetch(url, { ...options, headers });
        }

        // äº¤æ› Token
        async function exchangeToken(code) {
            const ctx = getAuthContext();
            if (!ctx.tokenEndpoint || !ctx.clientId || !ctx.redirectUri || !ctx.codeVerifier) {
                throw new Error('æˆæ¬Šä¸Šä¸‹æ–‡ä¸å®Œæ•´ï¼Œè«‹é‡æ–°å¾ launch.html é–‹å§‹');
            }

            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: ctx.redirectUri,
                client_id: ctx.clientId,
                code_verifier: ctx.codeVerifier
            });

            const res = await fetch(ctx.tokenEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`äº¤æ› Token å¤±æ•—: ${res.status} ${res.statusText} - ${errorText}`);
            }

            const tokenResponse = await res.json();
            sessionStorage.setItem('access_token', tokenResponse.access_token || '');
            sessionStorage.setItem('token_response', JSON.stringify(tokenResponse));
            if (tokenResponse.patient) {
                sessionStorage.setItem('patient_id', tokenResponse.patient);
            }
            return tokenResponse;
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // æª¢æŸ¥æˆæ¬Šç‹€æ…‹
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                if (error) {
                    throw new Error(`æˆæ¬Šå¤±æ•—: ${urlParams.get('error_description') || error}`);
                }

                const ctx = getAuthContext();
                fhirBaseUrl = ctx.iss;
                accessToken = sessionStorage.getItem('access_token');
                patientId = sessionStorage.getItem('patient_id');

                if (code) {
                    if (!state || state !== ctx.state) {
                        throw new Error('State é©—è­‰å¤±æ•—ï¼Œå¯èƒ½æ˜¯æˆæ¬Šæµç¨‹ä¸å®Œæ•´æˆ–è¢«æ””æˆª');
                    }

                    const tokenResponse = await exchangeToken(code);
                    accessToken = tokenResponse.access_token;
                    patientId = tokenResponse.patient || sessionStorage.getItem('patient_id');

                    // æ¸…é™¤ URL ä¸Šçš„ code/state
                    const cleanUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }

                if (!accessToken || !fhirBaseUrl) {
                    document.getElementById('patient-content').innerHTML = `
                        <div class="alert-box critical">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <h4>éŒ¯èª¤ï¼šç¼ºå°‘å®‰å…¨æ†‘è­‰</h4>
                                <p>æ­¤æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ SMART on FHIR æ¨™æº–å”è­°ï¼Œéœ€è¦ç¶“éæˆæ¬Šæµç¨‹æ‰èƒ½å­˜å–è³‡æ–™ã€‚</p>
                                <p style="margin-top: 10px;">
                                    <a href="./launch.html" style="color: #721c24; text-decoration: underline;">è«‹é‡æ–°æˆæ¬Š</a>
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (!patientId) {
                    throw new Error('æˆæ¬Šå®Œæˆä½†æ²’æœ‰å–å¾—ç—…äºº IDï¼Œè«‹ç¢ºèª scope åŒ…å« launch/patient ä¸¦å®Œæˆç—…äººé¸æ“‡');
                }

                // é©—è­‰ä¸¦æ›´æ–° patientIdï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
                // åªæœ‰åœ¨æŸ¥è©¢å¤±æ•—æ™‚æ‰ä½¿ç”¨ identifier å‚™æ´ï¼ŒæŸ¥è©¢æˆåŠŸå‰‡ä¿¡ä»»è©² Patient ID
                try {
                    const verifyRes = await authorizedFetch(`${fhirBaseUrl}/Patient/${patientId}`);
                    if (!verifyRes.ok) {
                        console.warn(`Patient ID ${patientId} æŸ¥è©¢å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ identifier æŸ¥æ‰¾...`);
                        const identifierQuery = `${fhirBaseUrl}/Patient?identifier=http://www.mohw.gov.tw/patient-id|U121745652`;
                        const identifierRes = await authorizedFetch(identifierQuery);
                        if (identifierRes.ok) {
                            const bundle = await identifierRes.json();
                            if (bundle.entry && bundle.entry.length > 0) {
                                const actualPatient = bundle.entry[0].resource;
                                patientId = actualPatient.id;
                                sessionStorage.setItem('patient_id', patientId);
                                console.log(`å·²æ›´æ–° Patient ID: ${patientId}`);
                            }
                        }
                    } else {
                        // æŸ¥è©¢æˆåŠŸï¼Œé©—è­‰ identifierï¼ˆåƒ…ç”¨æ–¼æ—¥èªŒè¨˜éŒ„ï¼Œä¸å¼·åˆ¶è¦æ±‚ï¼‰
                        const patient = await verifyRes.json();
                        const expectedIdentifier = patient.identifier?.find(
                            id => id.system === "http://www.mohw.gov.tw/patient-id" && id.value === "U121745652"
                        );
                        if (expectedIdentifier) {
                            console.log(`âœ“ Patient ID ${patientId} é©—è­‰é€šéï¼Œidentifier åŒ¹é…`);
                        } else {
                            // åƒ…è¨˜éŒ„è³‡è¨Šï¼Œä¸è¦–ç‚ºéŒ¯èª¤ï¼ˆå› ç‚º Patient ID æŸ¥è©¢å·²æˆåŠŸï¼‰
                            console.info(`â„¹ Patient ID ${patientId} æŸ¥è©¢æˆåŠŸï¼Œä½† identifier ä¸åŒ¹é…ï¼ˆé€™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå–æ±ºæ–¼ FHIR Server çš„è³‡æ–™çµæ§‹ï¼‰`);
                        }
                    }
                } catch (error) {
                    console.warn('é©—è­‰ Patient ID æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç¹¼çºŒä½¿ç”¨åŸå§‹ ID:', error);
                }

                // è¼‰å…¥ç—…äººè³‡æ–™
                await loadPatientData();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('patient-content').innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>åˆå§‹åŒ–å¤±æ•—</h4>
                            <p>${error.message}</p>
                            <p style="margin-top: 10px;">
                                <a href="./launch.html" style="color: #721c24; text-decoration: underline;">è«‹é‡æ–°æˆæ¬Š</a>
                            </p>
                        </div>
                    </div>
                `;
            }
        });

        // è¼‰å…¥ç—…äººè³‡æ–™
        async function loadPatientData() {
            try {
                if (!accessToken || !fhirBaseUrl || !patientId) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }

                let res = await authorizedFetch(`${fhirBaseUrl}/Patient/${patientId}`);
                let patient;
                
                // å¦‚æœä½¿ç”¨ ID æŸ¥è©¢å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ identifier æŸ¥è©¢
                if (!res.ok) {
                    console.warn(`ä½¿ç”¨ Patient ID ${patientId} æŸ¥è©¢å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ identifier æŸ¥è©¢...`);
                    // ä½¿ç”¨ identifier æŸ¥è©¢ï¼ˆå‡è¨­ identifier ç‚º U121745652ï¼‰
                    const identifierQuery = `${fhirBaseUrl}/Patient?identifier=http://www.mohw.gov.tw/patient-id|U121745652`;
                    res = await authorizedFetch(identifierQuery);
                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error(`è®€å–ç—…äººè³‡æ–™å¤±æ•—: ${res.status} ${res.statusText} - ${text}`);
                    }
                    const bundle = await res.json();
                    if (bundle.entry && bundle.entry.length > 0) {
                        patient = bundle.entry[0].resource;
                        // æ›´æ–° patientId ç‚ºå¯¦éš›çš„ ID
                        patientId = patient.id;
                        sessionStorage.setItem('patient_id', patientId);
                        console.log(`æ‰¾åˆ° Patientï¼Œå¯¦éš› ID: ${patientId}`);
                    } else {
                        throw new Error('ä½¿ç”¨ identifier æŸ¥è©¢æœªæ‰¾åˆ° Patient');
                    }
                } else {
                    patient = await res.json();
                    // ç¢ºä¿ä½¿ç”¨ Patient è³‡æºä¸­çš„å¯¦éš› ID
                    if (patient.id && patient.id !== patientId) {
                        console.log(`æ›´æ–° Patient ID: ${patientId} -> ${patient.id}`);
                        patientId = patient.id;
                        sessionStorage.setItem('patient_id', patientId);
                    }
                    // è¨˜éŒ„ identifier é©—è­‰ï¼ˆåƒ…ç”¨æ–¼æ—¥èªŒï¼Œä¸å½±éŸ¿æµç¨‹ï¼‰
                    const expectedIdentifier = patient.identifier?.find(
                        id => id.system === "http://www.mohw.gov.tw/patient-id" && id.value === "U121745652"
                    );
                    if (expectedIdentifier) {
                        console.log(`âœ“ Patient ID ${patientId} é©—è­‰é€šéï¼Œidentifier åŒ¹é…`);
                    } else {
                        console.info(`â„¹ Patient ID ${patientId} æŸ¥è©¢æˆåŠŸï¼Œidentifier é©—è­‰ï¼š${patient.identifier ? 'identifier å­˜åœ¨ä½†å€¼ä¸åŒ¹é…' : 'identifier ä¸å­˜åœ¨'}`);
                    }
                }
                
                console.log('è¼‰å…¥çš„ Patient:', { id: patient.id, identifier: patient.identifier });
                patientData = patient;

                // æ ¼å¼åŒ–é¡¯ç¤º
                const name = patient.name?.[0] ? 
                    `${patient.name[0].family || ''}${patient.name[0].given?.join('') || ''}`.trim() : 
                    'æœªçŸ¥';
                const gender = patient.gender === 'male' ? 'ç”·æ€§' : patient.gender === 'female' ? 'å¥³' : 'æœªçŸ¥';
                const birthDate = patient.birthDate || 'æœªçŸ¥';
                const age = birthDate !== 'æœªçŸ¥' ? 
                    Math.floor((new Date() - new Date(birthDate)) / (365.25 * 24 * 60 * 60 * 1000)) : 'æœªçŸ¥';

                // å–å¾—æ“´å±•è³‡æ–™ï¼ˆåœ°å€ã€é›»è©±ç­‰ï¼‰
                const address = patient.address?.[0] ? 
                    `${patient.address[0].postalCode || ''}${patient.address[0].city || ''}${patient.address[0].district || ''}`.trim() : 
                    'æœªæä¾›';
                const phone = patient.telecom?.find(t => t.system === 'phone')?.value || 'æœªæä¾›';

                // å–å¾—ç¤¾æœƒå²ï¼ˆå¾ Patient è³‡æºçš„ extension ä¸­æå–ï¼‰
                const socialHistory = extractSocialHistory(patient);

                const html = `
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>åŸºæœ¬è³‡æ–™</h3>
                            <div class="info-row">
                                <span class="info-label">å§“å</span>
                                <span class="info-value">${name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å‡ºç”Ÿæ—¥æœŸ</span>
                                <span class="info-value">${birthDate}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">èº«åˆ†è­‰å­—è™Ÿ</span>
                                <span class="info-value">${patient.identifier?.[0]?.value || 'æœªæä¾›'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">åœ°å€</span>
                                <span class="info-value">${address}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å°±è¨ºæ©Ÿæ§‹</span>
                                <span class="info-value">${patient.managingOrganization?.display || 'æœªæä¾›'}</span>
                            </div>
                        </div>
                        <div class="info-card">
                            <h3>è¯çµ¡è³‡è¨Š</h3>
                            <div class="info-row">
                                <span class="info-label">æ€§åˆ¥</span>
                                <span class="info-value">${gender}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å¹´é½¡</span>
                                <span class="info-value">${age}æ­²</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è¯çµ¡é›»è©±</span>
                                <span class="info-value">${phone}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä¸»æ²»é†«å¸«</span>
                                <span class="info-value">${patient.generalPractitioner?.[0]?.display || 'æœªæŒ‡å®š'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="info-card">
                        <h3>ç¤¾æœƒå²èˆ‡ç”Ÿæ´»ç¿’æ…£</h3>
                        <div class="info-row">
                            <span class="info-label">é£²é…’ç¿’æ…£</span>
                            <span class="info-value">${socialHistory.drinking || 'æœªæä¾›'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">é‹å‹•ç¿’æ…£</span>
                            <span class="info-value">${socialHistory.exercise || 'æœªæä¾›'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æª³æ¦”ç¿’æ…£</span>
                            <span class="info-value">${socialHistory.betelNut || 'æœªæä¾›'}</span>
                        </div>
                    </div>
                `;

                document.getElementById('patient-content').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥ç—…äººè³‡æ–™å¤±æ•—:', error);
                document.getElementById('patient-content').innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>è¼‰å…¥å¤±æ•—</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // è¼‰å…¥ç”Ÿç†æ•¸æ“š
        async function loadLabReports() {
            try {
                if (!accessToken || !fhirBaseUrl || !patientId) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }

                const res = await authorizedFetch(`${fhirBaseUrl}/Observation?subject=Patient/${patientId}`);
                if (!res.ok) {
                    throw new Error(`è®€å– Observation å¤±æ•—: ${res.status} ${res.statusText}`);
                }
                const observations = await res.json();
                observationsData = observations;

                // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“š
                const entries = observations.entry || [];
                if (entries.length === 0) {
                    document.getElementById('lab-content').innerHTML = `
                        <div class="alert-box" style="background: #fff3cd; border-left-color: #ffc107;">
                            <span class="alert-icon">â„¹ï¸</span>
                            <div class="alert-content">
                                <h4>ç›®å‰æ²’æœ‰ç”Ÿç†æ•¸æ“š</h4>
                                <p>æ­¤ç—…äººçš„ç”Ÿç†æ•¸æ“šå°šæœªä¸Šå‚³åˆ° FHIR ä¼ºæœå™¨ã€‚</p>
                                <p style="margin-top: 10px; font-size: 14px; color: #856404;">
                                    è«‹å…ˆä¸Šå‚³ç”Ÿç†æ•¸æ“šï¼Œæˆ–ç¢ºèªç—…äºº ID æ˜¯å¦æ­£ç¢ºã€‚
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const labData = categorizeObservations(observations);
                const html = renderLabReports(labData);

                document.getElementById('lab-content').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥ç”Ÿç†æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('lab-content').innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>è¼‰å…¥å¤±æ•—</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // è¼‰å…¥è‡¨åºŠè©•ä¼°
        async function loadClinicalAssessment() {
            try {
                if (!accessToken || !fhirBaseUrl || !patientId) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }

                // å–å¾—æ‰€æœ‰ç›¸é—œè³‡æ–™
                const obsRes = await authorizedFetch(`${fhirBaseUrl}/Observation?subject=Patient/${patientId}`);
                const observations = await obsRes.json();
                
                const condRes = await authorizedFetch(`${fhirBaseUrl}/Condition?subject=Patient/${patientId}`);
                const conditions = await condRes.json();

                conditionsData = conditions;
                observationsData = observations;

                // è¨ˆç®—ä»£è¬ç—‡å€™ç¾¤è©•ä¼°
                const assessment = assessMetabolicSyndrome(observations, patientData);
                const scores = calculateHealthScores(observations, assessment);
                const riskFactors = identifyRiskFactors(assessment);

                const html = renderClinicalAssessment(assessment, scores, riskFactors);

                document.getElementById('clinical-content').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥è‡¨åºŠè©•ä¼°å¤±æ•—:', error);
                document.getElementById('clinical-content').innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>è¼‰å…¥å¤±æ•—</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }


        // è¼”åŠ©å‡½æ•¸ï¼šæå–ç¤¾æœƒå²
        function extractSocialHistory(patient) {
            const socialHistory = {
                drinking: 'æœªæä¾›',
                exercise: 'æœªæä¾›',
                betelNut: 'æœªæä¾›'
            };

            // å¾ Patient è³‡æºçš„ extension ä¸­æå–ç¤¾æœƒå²è³‡æ–™
            if (patient && patient.extension) {
                // å°‹æ‰¾ç¤¾æœƒå² extension
                const socialHistoryExtension = patient.extension.find(
                    ext => ext.url === "http://twcore.mohw.gov.tw/fhir/StructureDefinition/tw-patient-social-history"
                );

                if (socialHistoryExtension && socialHistoryExtension.extension) {
                    socialHistoryExtension.extension.forEach(ext => {
                        if (ext.url === "drinking" && ext.valueString) {
                            socialHistory.drinking = ext.valueString;
                        } else if (ext.url === "exercise" && ext.valueString) {
                            socialHistory.exercise = ext.valueString;
                        } else if (ext.url === "betelNut" && ext.valueString) {
                            socialHistory.betelNut = ext.valueString;
                        }
                    });
                }
            }

            return socialHistory;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šåˆ†é¡æª¢é©—é …ç›®
        function categorizeObservations(observations) {
            const categories = {
                bloodPressure: [],
                bloodGlucose: [],
                bloodLipids: [],
                liverFunction: [],
                kidneyFunction: []
            };

            const entries = observations.entry || [];
            entries.forEach(entry => {
                const obs = entry.resource;
                const code = obs.code?.coding?.[0]?.code;

                // è¡€å£“
                if (code === '85354-9') {
                    categories.bloodPressure.push(obs);
                }
                // è¡€ç³–
                else if (['33747-0', '33748-8', '2339-0'].includes(code)) {
                    categories.bloodGlucose.push(obs);
                }
                // è¡€è„‚
                else if (['2093-3', '2571-8', '2085-9', '2089-1'].includes(code)) {
                    categories.bloodLipids.push(obs);
                }
                // è‚åŠŸèƒ½
                else if (['1975-2', '1968-7'].includes(code)) {
                    categories.liverFunction.push(obs);
                }
                // è…åŠŸèƒ½
                else if (['2160-0', '33914-3'].includes(code)) {
                    categories.kidneyFunction.push(obs);
                }
            });

            return categories;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“ç”Ÿç†æ•¸æ“š
        function renderLabReports(labData) {
            let html = '';

            // è¡€å£“
            if (labData.bloodPressure.length > 0) {
                html += renderLabSection('â¤ è¡€å£“', labData.bloodPressure, 'bloodPressure');
            }

            // è¡€ç³–
            if (labData.bloodGlucose.length > 0) {
                html += renderLabSection('ğŸ’§ è¡€ç³–', labData.bloodGlucose, 'bloodGlucose');
            }

            // è¡€è„‚
            if (labData.bloodLipids.length > 0) {
                html += renderLabSection('ğŸ§ª è¡€è„‚', labData.bloodLipids, 'bloodLipids');
            }

            // è‚åŠŸèƒ½
            if (labData.liverFunction.length > 0) {
                html += renderLabSection('ğŸ”¬ è‚åŠŸèƒ½', labData.liverFunction, 'liverFunction');
            }

            // è…åŠŸèƒ½
            if (labData.kidneyFunction.length > 0) {
                html += renderLabSection('âš—ï¸ è…åŠŸèƒ½', labData.kidneyFunction, 'kidneyFunction');
            }

            return html || '<p>ç›®å‰æ²’æœ‰ç”Ÿç†æ•¸æ“šè³‡æ–™</p>';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“å–®ä¸€æª¢é©—é¡åˆ¥
        function renderLabSection(title, observations, category) {
            const rows = observations.map(obs => {
                const code = obs.code?.coding?.[0]?.code;
                const display = obs.code?.coding?.[0]?.display || obs.code?.text || 'æœªçŸ¥';
                const value = extractObservationValue(obs);
                const referenceRange = extractReferenceRange(obs);
                const date = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
                const interpretation = determineInterpretation(obs, referenceRange);

                return `
                    <tr>
                        <td>${getDisplayName(code, display)}</td>
                        <td>${value}</td>
                        <td>${referenceRange}</td>
                        <td>${date}</td>
                        <td>
                            <span class="status-badge ${interpretation.status === 'normal' ? 'status-normal' : 'status-abnormal'}">
                                ${interpretation.label}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="lab-section">
                    <h3>${title}</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æª¢æŸ¥é …ç›®</th>
                                <th>æª¢æ¸¬çµæœ</th>
                                <th>æ­£å¸¸ç¯„åœ</th>
                                <th>æª¢é©—æ—¥æœŸ</th>
                                <th>åˆ¤å®š</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæå–è§€æ¸¬å€¼
        function extractObservationValue(obs) {
            if (obs.valueQuantity) {
                return `${obs.valueQuantity.value} ${obs.valueQuantity.unit || ''}`;
            } else if (obs.component) {
                // è¡€å£“æœ‰å…©å€‹ component
                const systolic = obs.component.find(c => c.code?.coding?.[0]?.code === '8480-6');
                const diastolic = obs.component.find(c => c.code?.coding?.[0]?.code === '8462-4');
                if (systolic && diastolic) {
                    return `${systolic.valueQuantity.value}/${diastolic.valueQuantity.value} ${systolic.valueQuantity.unit || 'mmHg'}`;
                }
            }
            return 'æœªçŸ¥';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæå–åƒè€ƒç¯„åœ
        function extractReferenceRange(obs) {
            if (obs.referenceRange && obs.referenceRange.length > 0) {
                const range = obs.referenceRange[0];
                if (range.text) return range.text;
                if (range.low && range.high) {
                    return `${range.low.value}${range.low.unit || ''} - ${range.high.value}${range.high.unit || ''}`;
                } else if (range.low) {
                    return `> ${range.low.value}${range.low.unit || ''}`;
                } else if (range.high) {
                    return `< ${range.high.value}${range.high.unit || ''}`;
                }
            }
            return 'æœªæä¾›';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šåˆ¤æ–·è§£è®€
        function determineInterpretation(obs, referenceRange) {
            if (obs.interpretation && obs.interpretation.length > 0) {
                const interp = obs.interpretation[0];
                const code = interp.coding?.[0]?.code;
                if (code === 'H' || code === 'HH') {
                    return { status: 'abnormal', label: 'åé«˜' };
                } else if (code === 'L' || code === 'LL') {
                    return { status: 'abnormal', label: 'åä½' };
                } else if (code === 'N') {
                    return { status: 'normal', label: 'æ­£å¸¸' };
                }
            }
            return { status: 'normal', label: 'æ­£å¸¸' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—é¡¯ç¤ºåç¨±
        function getDisplayName(code, display) {
            const nameMap = {
                '8480-6': 'æ”¶ç¸®å£“',
                '8462-4': 'èˆ’å¼µå£“',
                '33747-0': 'ç©ºè…¹è¡€ç³–',
                '2339-0': 'è¡€ç³–',
                '2093-3': 'ç¸½è†½å›ºé†‡',
                '2571-8': 'ä¸‰é…¸ç”˜æ²¹è„‚',
                '2085-9': 'HDLè†½å›ºé†‡',
                '2089-1': 'LDLè†½å›ºé†‡',
                '1975-2': 'ALT/GPT',
                '1968-7': 'AST/GOT',
                '2160-0': 'è‚Œé…¸é…',
                '33914-3': 'å°¿é…¸'
            };
            return nameMap[code] || display || 'æœªçŸ¥';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šè©•ä¼°ä»£è¬ç—‡å€™ç¾¤
        function assessMetabolicSyndrome(observations, patient) {
            const criteria = {
                waistCircumference: { value: null, abnormal: false, threshold: 90 },
                bloodPressure: { systolic: null, diastolic: null, abnormal: false, threshold: { systolic: 130, diastolic: 85 } },
                fastingGlucose: { value: null, abnormal: false, threshold: 100 },
                triglycerides: { value: null, abnormal: false, threshold: 150 },
                hdlCholesterol: { value: null, abnormal: false, threshold: 40, gender: patient?.gender }
            };

            const entries = observations.entry || [];
            entries.forEach(entry => {
                const obs = entry.resource;
                const code = obs.code?.coding?.[0]?.code;

                // è¡€å£“
                if (code === '85354-9' && obs.component) {
                    const systolic = obs.component.find(c => c.code?.coding?.[0]?.code === '8480-6');
                    const diastolic = obs.component.find(c => c.code?.coding?.[0]?.code === '8462-4');
                    if (systolic) criteria.bloodPressure.systolic = systolic.valueQuantity.value;
                    if (diastolic) criteria.bloodPressure.diastolic = diastolic.valueQuantity.value;
                }
                // ç©ºè…¹è¡€ç³–
                else if (code === '33747-0') {
                    criteria.fastingGlucose.value = obs.valueQuantity.value;
                }
                // ä¸‰é…¸ç”˜æ²¹è„‚
                else if (code === '2571-8') {
                    criteria.triglycerides.value = obs.valueQuantity.value;
                }
                // HDLè†½å›ºé†‡
                else if (code === '2085-9') {
                    criteria.hdlCholesterol.value = obs.valueQuantity.value;
                }
            });

            // åˆ¤æ–·ç•°å¸¸
            criteria.waistCircumference.abnormal = criteria.waistCircumference.value > criteria.waistCircumference.threshold;
            criteria.bloodPressure.abnormal = criteria.bloodPressure.systolic > criteria.bloodPressure.threshold.systolic || 
                                            criteria.bloodPressure.diastolic > criteria.bloodPressure.threshold.diastolic;
            criteria.fastingGlucose.abnormal = criteria.fastingGlucose.value > criteria.fastingGlucose.threshold;
            criteria.triglycerides.abnormal = criteria.triglycerides.value > criteria.triglycerides.threshold;
            
            const hdlThreshold = criteria.hdlCholesterol.gender === 'female' ? 50 : 40;
            criteria.hdlCholesterol.abnormal = criteria.hdlCholesterol.value < hdlThreshold;

            // è¨ˆç®—ç¬¦åˆé …ç›®æ•¸
            const abnormalCount = [
                criteria.waistCircumference.abnormal,
                criteria.bloodPressure.abnormal,
                criteria.fastingGlucose.abnormal,
                criteria.triglycerides.abnormal,
                criteria.hdlCholesterol.abnormal
            ].filter(Boolean).length;

            return {
                criteria,
                abnormalCount,
                meetsCriteria: abnormalCount >= 3
            };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å¥åº·è©•åˆ†
        function calculateHealthScores(observations, assessment) {
            // ç°¡åŒ–çš„è©•åˆ†é‚è¼¯
            const overallScore = 80;
            const metabolicScore = assessment.meetsCriteria ? 70 : 85;
            const cardiovascularScore = 77;
            const kidneyLiverScore = 100;

            return {
                overall: overallScore,
                metabolic: metabolicScore,
                cardiovascular: cardiovascularScore,
                kidneyLiver: kidneyLiverScore
            };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šè­˜åˆ¥å±éšªå› å­
        function identifyRiskFactors(assessment) {
            const factors = [];
            const criteria = assessment.criteria;

            if (criteria.waistCircumference.abnormal) {
                factors.push({
                    title: 'è…°åœéå¤§',
                    description: 'ä¸­å¿ƒå‹è‚¥èƒ–æœƒå¢åŠ å¿ƒè¡€ç®¡ç–¾ç—…é¢¨éšª'
                });
            }
            if (criteria.bloodPressure.abnormal) {
                factors.push({
                    title: 'è¡€å£“åé«˜',
                    description: 'é«˜è¡€å£“æ˜¯å¿ƒè¡€ç®¡ç–¾ç—…çš„ä¸»è¦å±éšªå› å­'
                });
            }
            if (criteria.triglycerides.abnormal) {
                factors.push({
                    title: 'ä¸‰é…¸ç”˜æ²¹è„‚éé«˜',
                    description: 'å¯èƒ½å¢åŠ å¿ƒè¡€ç®¡ç–¾ç—…é¢¨éšª'
                });
            }

            return factors;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“è‡¨åºŠè©•ä¼°
        function renderClinicalAssessment(assessment, scores, riskFactors) {
            const criteria = assessment.criteria;
            const meetsCriteria = assessment.meetsCriteria;
            const abnormalCount = assessment.abnormalCount;

            let html = '';

            // ä»£è¬ç—‡å€™ç¾¤è­¦ç¤º
            if (meetsCriteria) {
                html += `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>ç¬¦åˆä»£è¬ç—‡å€™ç¾¤æ¨™æº–</h4>
                            <p>ç¬¦åˆä»£è¬ç—‡å€™ç¾¤è¨ºæ–·æ¨™æº– ${abnormalCount}/5 é …å±éšªå› å­</p>
                        </div>
                    </div>
                `;
            }

            // å¥åº·è©•åˆ†ç¸½è¦½
            html += `
                <div class="lab-section">
                    <h3>â° å¥åº·è©•åˆ†ç¸½è¦½</h3>
                    <div class="score-grid">
                        <div class="score-card">
                            <div class="score-value">${scores.overall}</div>
                            <div class="score-label">æ•´é«”å¥åº·</div>
                        </div>
                        <div class="score-card metabolic">
                            <div class="score-value">${scores.metabolic}</div>
                            <div class="score-label">ä»£è¬å¥åº·</div>
                        </div>
                        <div class="score-card cardiovascular">
                            <div class="score-value">${scores.cardiovascular}</div>
                            <div class="score-label">å¿ƒè¡€ç®¡å¥åº·</div>
                        </div>
                        <div class="score-card kidney-liver">
                            <div class="score-value">${scores.kidneyLiver}</div>
                            <div class="score-label">è‚è…åŠŸèƒ½</div>
                        </div>
                    </div>
                </div>
            `;

            // äº”å¤§å±éšªå› å­æª¢æŸ¥
            html += `
                <div class="lab-section">
                    <h3>â™¥ äº”å¤§å±éšªå› å­æª¢æŸ¥</h3>
                    <div class="metabolic-criteria">
                        <div class="criteria-card ${criteria.waistCircumference.abnormal ? 'abnormal' : 'normal'}">
                            <h4>è…°åœ</h4>
                            <div class="criteria-value">${criteria.waistCircumference.value || 'æœªæ¸¬é‡'} cm</div>
                            <div class="criteria-reference">åƒè€ƒå€¼: < ${criteria.waistCircumference.threshold} cm</div>
                            <span class="status-badge ${criteria.waistCircumference.abnormal ? 'status-abnormal' : 'status-normal'}">
                                ${criteria.waistCircumference.abnormal ? 'ç•°å¸¸' : 'æ­£å¸¸'}
                            </span>
                        </div>
                        <div class="criteria-card ${criteria.bloodPressure.abnormal ? 'abnormal' : 'normal'}">
                            <h4>è¡€å£“</h4>
                            <div class="criteria-value">${criteria.bloodPressure.systolic || '--'}/${criteria.bloodPressure.diastolic || '--'} mmHg</div>
                            <div class="criteria-reference">åƒè€ƒå€¼: < ${criteria.bloodPressure.threshold.systolic}/${criteria.bloodPressure.threshold.diastolic} mmHg</div>
                            <span class="status-badge ${criteria.bloodPressure.abnormal ? 'status-abnormal' : 'status-normal'}">
                                ${criteria.bloodPressure.abnormal ? 'ç•°å¸¸' : 'æ­£å¸¸'}
                            </span>
                        </div>
                        <div class="criteria-card ${criteria.fastingGlucose.abnormal ? 'abnormal' : 'normal'}">
                            <h4>ç©ºè…¹è¡€ç³–</h4>
                            <div class="criteria-value">${criteria.fastingGlucose.value || 'æœªæ¸¬é‡'} mg/dl</div>
                            <div class="criteria-reference">åƒè€ƒå€¼: < ${criteria.fastingGlucose.threshold} mg/dL</div>
                            <span class="status-badge ${criteria.fastingGlucose.abnormal ? 'status-abnormal' : 'status-normal'}">
                                ${criteria.fastingGlucose.abnormal ? 'ç•°å¸¸' : 'æ­£å¸¸'}
                            </span>
                        </div>
                        <div class="criteria-card ${criteria.triglycerides.abnormal ? 'abnormal' : 'normal'}">
                            <h4>ä¸‰é…¸ç”˜æ²¹è„‚</h4>
                            <div class="criteria-value">${criteria.triglycerides.value || 'æœªæ¸¬é‡'} mg/dl</div>
                            <div class="criteria-reference">åƒè€ƒå€¼: < ${criteria.triglycerides.threshold} mg/dL</div>
                            <span class="status-badge ${criteria.triglycerides.abnormal ? 'status-abnormal' : 'status-normal'}">
                                ${criteria.triglycerides.abnormal ? 'ç•°å¸¸' : 'æ­£å¸¸'}
                            </span>
                        </div>
                        <div class="criteria-card ${criteria.hdlCholesterol.abnormal ? 'abnormal' : 'normal'}">
                            <h4>HDLè†½å›ºé†‡</h4>
                            <div class="criteria-value">${criteria.hdlCholesterol.value || 'æœªæ¸¬é‡'} mg/dl</div>
                            <div class="criteria-reference">åƒè€ƒå€¼: > ${criteria.hdlCholesterol.gender === 'female' ? 50 : 40} mg/dL</div>
                            <span class="status-badge ${criteria.hdlCholesterol.abnormal ? 'status-abnormal' : 'status-normal'}">
                                ${criteria.hdlCholesterol.abnormal ? 'ç•°å¸¸' : 'æ­£å¸¸'}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            // å±éšªå› å­åˆ†æ
            if (riskFactors.length > 0) {
                html += `
                    <div class="lab-section">
                        <h3>âš ï¸ å±éšªå› å­åˆ†æ</h3>
                        <div class="risk-factors">
                            ${riskFactors.map(factor => `
                                <div class="risk-factor-card">
                                    <span class="risk-icon">âš ï¸</span>
                                    <div class="risk-content">
                                        <h4>${factor.title}</h4>
                                        <p>${factor.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // åŒ¯å‡º JSON
        function exportJSON(resources) {
            const jsonStr = JSON.stringify(resources, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metabolic-syndrome-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('export-result').innerHTML = `
                <div class="alert-box" style="background: #d4edda; border-left-color: #28a745;">
                    <span class="alert-icon">âœ“</span>
                    <div class="alert-content">
                        <h4 style="color: #155724;">åŒ¯å‡ºæˆåŠŸ</h4>
                        <p style="color: #155724;">JSON æª”æ¡ˆå·²ä¸‹è¼‰</p>
                    </div>
                </div>
            `;
        }

        // åŒ¯å‡º CSV
        function exportCSV(resources) {
            // ç°¡åŒ–çš„ CSV åŒ¯å‡º
            let csv = 'æª¢æŸ¥é …ç›®,æª¢æ¸¬çµæœ,æ­£å¸¸ç¯„åœ,æª¢é©—æ—¥æœŸ,åˆ¤å®š\n';
            
            if (resources.observations) {
                resources.observations.forEach(obs => {
                    const code = obs.code?.coding?.[0]?.code;
                    const display = getDisplayName(code, obs.code?.coding?.[0]?.display || '');
                    const value = extractObservationValue(obs);
                    const referenceRange = extractReferenceRange(obs);
                    const date = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
                    const interpretation = determineInterpretation(obs, referenceRange);
                    
                    csv += `${display},${value},${referenceRange},${date},${interpretation.label}\n`;
                });
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metabolic-syndrome-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('export-result').innerHTML = `
                <div class="alert-box" style="background: #d4edda; border-left-color: #28a745;">
                    <span class="alert-icon">âœ“</span>
                    <div class="alert-content">
                        <h4 style="color: #155724;">åŒ¯å‡ºæˆåŠŸ</h4>
                        <p style="color: #155724;">CSV æª”æ¡ˆå·²ä¸‹è¼‰</p>
                    </div>
                </div>
            `;
        }

        // è¼‰å…¥è¡€å£“è¶¨å‹¢
        async function loadBloodPressureTrend() {
            try {
                if (!accessToken || !fhirBaseUrl || !patientId) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }

                // æŸ¥è©¢è¡€å£“ Observationï¼ˆLOINC code: 85354-9ï¼‰
                const res = await authorizedFetch(`${fhirBaseUrl}/Observation?subject=Patient/${patientId}&code=85354-9`);
                if (!res.ok) {
                    throw new Error(`è®€å– Observation å¤±æ•—: ${res.status} ${res.statusText}`);
                }
                const observations = await res.json();

                const bpData = parseBloodPressureObservations(observations);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›æ•¸æ“š
                if (bpData.length === 0) {
                    document.getElementById('bp-content').innerHTML = `
                        <div class="alert-box" style="background: #fff3cd; border-left-color: #ffc107;">
                            <span class="alert-icon">â„¹ï¸</span>
                            <div class="alert-content">
                                <h4>ç›®å‰æ²’æœ‰è¡€å£“æ•¸æ“š</h4>
                                <p>æ­¤ç—…äººçš„è¡€å£“æ•¸æ“šå°šæœªä¸Šå‚³åˆ° FHIR ä¼ºæœå™¨ã€‚</p>
                                <p style="margin-top: 10px; font-size: 14px; color: #856404;">
                                    è«‹å…ˆä¸Šå‚³è¡€å£“æ•¸æ“šï¼Œæˆ–ç¢ºèªç—…äºº ID æ˜¯å¦æ­£ç¢ºã€‚
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // æ¸²æŸ“åœ–è¡¨
                const html = `
                    <div style="max-width: 1400px; margin: 0 auto;">
                        <div class="chart-container">
                            <div class="chart-title">è¡€å£“è¶¨å‹¢åœ–</div>
                            <div class="chart-wrapper">
                                <canvas id="bpChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">è¡€å£“ç´€éŒ„åˆ†å¸ƒåœ–</div>
                            <div class="chart-wrapper">
                                <canvas id="bpDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('bp-content').innerHTML = html;

                // ç¹ªè£½åœ–è¡¨
                renderBloodPressureChart(bpData);
                renderBloodPressureDistribution(bpData);
            } catch (error) {
                console.error('è¼‰å…¥è¡€å£“è¶¨å‹¢å¤±æ•—:', error);
                document.getElementById('bp-content').innerHTML = `
                    <div class="alert-box critical">
                        <span class="alert-icon">âš ï¸</span>
                        <div class="alert-content">
                            <h4>è¼‰å…¥å¤±æ•—</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // è§£æè¡€å£“ Observation
        function parseBloodPressureObservations(observations) {
            const entries = observations.entry || [];
            return entries.map(entry => {
                const obs = entry.resource;
                const systolic = obs.component?.find(c => c.code?.coding?.[0]?.code === '8480-6')?.valueQuantity?.value;
                const diastolic = obs.component?.find(c => c.code?.coding?.[0]?.code === '8462-4')?.valueQuantity?.value;
                return {
                    date: obs.effectiveDateTime,
                    systolic: systolic,
                    diastolic: diastolic
                };
            }).filter(d => d.systolic && d.diastolic)
              .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // ç¹ªè£½è¡€å£“è¶¨å‹¢åœ–
        function renderBloodPressureChart(data) {
            const ctx = document.getElementById('bpChart');
            if (!ctx) return;
            
            if (bpChart) {
                bpChart.destroy();
            }

            // è¨ˆç®—æ‰€æœ‰æ•¸æ“šçš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œä»¥å®Œæ•´å‘ˆç¾æ‰€æœ‰æ•¸æ“š
            const allValues = [
                ...data.map(d => d.systolic),
                ...data.map(d => d.diastolic)
            ].filter(v => v != null && !isNaN(v));
            
            const minValue = Math.min(...allValues);
            const maxValue = Math.max(...allValues);
            
            // è¨­å®š y è»¸ç¯„åœï¼Œç•™å‡ºä¸€äº›é‚Šè·ä»¥ä¾¿å®Œæ•´é¡¯ç¤º
            const padding = Math.max(10, (maxValue - minValue) * 0.1);
            const yMin = Math.max(0, Math.floor(minValue - padding));
            const yMax = Math.ceil(maxValue + padding);
            
            // è¨ˆç®—åˆé©çš„æ­¥é•·
            const range = yMax - yMin;
            const stepSize = range <= 30 ? 5 : range <= 60 ? 10 : range <= 120 ? 20 : 25;

            bpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString('zh-TW')),
                    datasets: [
                        {
                            label: 'æ”¶ç¸®å£“ (mmHg)',
                            data: data.map(d => d.systolic),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'èˆ’å¼µå£“ (mmHg)',
                            data: data.map(d => d.diastolic),
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' mmHg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yMin,
                            max: yMax,
                            title: {
                                display: true,
                                text: 'è¡€å£“ (mmHg)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                stepSize: stepSize,
                                callback: function(value) {
                                    return value + ' mmHg';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½è¡€å£“åˆ†å¸ƒåœ–
        function renderBloodPressureDistribution(data) {
            const ctx = document.getElementById('bpDistributionChart');
            if (!ctx) return;

            if (distributionChart) {
                distributionChart.destroy();
            }

            const distribution = calculateBloodPressureDistribution(data);

            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ­£å¸¸', 'åé«˜', 'é«˜'],
                    datasets: [{
                        label: 'è¡€å£“åˆ†å¸ƒ',
                        data: distribution,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ],
                        borderColor: [
                            'rgb(75, 192, 192)',
                            'rgb(255, 206, 86)',
                            'rgb(255, 99, 132)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'è¨˜éŒ„æ¬¡æ•¸',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'è¡€å£“åˆ†é¡',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // è¨ˆç®—è¡€å£“åˆ†å¸ƒ
        function calculateBloodPressureDistribution(data) {
            let normal = 0, high = 0, veryHigh = 0;
            data.forEach(d => {
                if (d.systolic >= 140 || d.diastolic >= 90) {
                    veryHigh++;
                } else if (d.systolic >= 130 || d.diastolic >= 85) {
                    high++;
                } else {
                    normal++;
                }
            });
            return [normal, high, veryHigh];
        }
    </script>
</body>
</html>
