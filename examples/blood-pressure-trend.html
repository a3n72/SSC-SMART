<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSC-SMART - è¡€å£“è¶¨å‹¢</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .header h1 {
            flex: 1;
            font-size: 18px;
            color: #2c3e50;
        }
        .header-icons {
            display: flex;
            gap: 15px;
        }
        .tabs {
            background: white;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
        }
        .tab-btn.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        .edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: #6c757d;
        }
        .footer-item.active {
            color: #3498db;
        }
        .footer-item span {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
        <h1>å¾¡æ›²åŒå·¥å…¨äººæ•´åˆç…§è­·SMARTå¹³å° - è¡€å£“è¶¨å‹¢</h1>
        <div class="header-icons">
            <span>ğŸ””</span>
            <span>ğŸ’¬</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchPeriod('day', event)">æ—¥</button>
        <button class="tab-btn" onclick="switchPeriod('month', event)">æœˆ</button>
        <button class="tab-btn" onclick="switchPeriod('year', event)">å¹´</button>
        <button class="tab-btn" onclick="switchView('asc', event)">å‡</button>
        <button class="tab-btn" onclick="switchView('desc', event)">é™</button>
        <button class="tab-btn" onclick="switchView('list', event)">åˆ—è¡¨</button>
    </div>

    <div class="container">
        <div class="chart-container">
            <div class="chart-title">è¡€å£“è¶¨å‹¢åœ–</div>
            <button class="edit-btn" onclick="editRecord()">âœï¸</button>
            <div class="chart-wrapper">
                <canvas id="bpChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <div class="chart-title">è¡€å£“ç´€éŒ„åˆ†å¸ƒåœ–</div>
            <div class="chart-wrapper">
                <canvas id="bpDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-item">
            <span>ğŸ’¬</span>
            <span>èŠå¤©å®¤</span>
        </div>
        <div class="footer-item">
            <span>ğŸ“…</span>
            <span>è¡Œäº‹æ›†</span>
        </div>
        <div class="footer-item active">
            <span>ğŸ </span>
            <span>é¦–é </span>
        </div>
        <div class="footer-item">
            <span>ğŸ“‹</span>
            <span>æ¸…å–®</span>
        </div>
        <div class="footer-item">
            <span>ğŸ”§</span>
            <span>å·¥å…·ç®±</span>
        </div>
    </div>

    <!-- è¼‰å…¥ fhirclient CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@2.6.3/build/fhir-client.min.js"></script>
    
    <script>
        // å…¨å±€è®Šæ•¸
        let bpChart = null;
        let distributionChart = null;
        let accessToken = null;
        let fhirBaseUrl = null;
        let patientId = null;

        // è¿”å›ä¸»é  - å¿…é ˆåœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šç¾©ï¼Œä¾› HTML onclick èª¿ç”¨
        window.goBack = function() {
            window.location.href = './metabolic-syndrome.html';
        };

        // ç·¨è¼¯è¨˜éŒ„
        window.editRecord = function() {
            alert('ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­');
        };

        // åˆ‡æ›æœŸé–“
        window.switchPeriod = function(period, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            // é‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆå¯ä»¥æ ¹æ“š period éæ¿¾è³‡æ–™ï¼‰
            if (accessToken && fhirBaseUrl && patientId) {
                loadBloodPressureData();
            }
        };

        // åˆ‡æ›è¦–åœ–
        window.switchView = function(view, event) {
            if (event && event.target) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
            // åˆ‡æ›è¦–åœ–é‚è¼¯
            if (view === 'list') {
                alert('åˆ—è¡¨è¦–åœ–åŠŸèƒ½é–‹ç™¼ä¸­');
            }
        };

        // å–å¾—æˆæ¬Šä¸Šä¸‹æ–‡
        function getAuthContext() {
            return {
                iss: sessionStorage.getItem('oauth_iss'),
                clientId: sessionStorage.getItem('oauth_client_id'),
                redirectUri: sessionStorage.getItem('oauth_redirect_uri'),
                scope: sessionStorage.getItem('oauth_scope'),
                tokenEndpoint: sessionStorage.getItem('oauth_token_endpoint'),
                state: sessionStorage.getItem('oauth_state'),
                codeVerifier: sessionStorage.getItem('oauth_code_verifier')
            };
        }

        // æˆæ¬Šçš„ fetch
        async function authorizedFetch(url, options = {}) {
            if (!accessToken) {
                throw new Error('ç¼ºå°‘ Access Tokenï¼Œè«‹é‡æ–°æˆæ¬Š');
            }
            const headers = {
                Accept: 'application/fhir+json',
                Authorization: `Bearer ${accessToken}`,
                ...(options.headers || {})
            };
            return fetch(url, { ...options, headers });
        }

        // äº¤æ› Token
        async function exchangeToken(code) {
            const ctx = getAuthContext();
            if (!ctx.tokenEndpoint || !ctx.clientId || !ctx.redirectUri || !ctx.codeVerifier) {
                throw new Error('æˆæ¬Šä¸Šä¸‹æ–‡ä¸å®Œæ•´ï¼Œè«‹é‡æ–°å¾ launch.html é–‹å§‹');
            }

            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: ctx.redirectUri,
                client_id: ctx.clientId,
                code_verifier: ctx.codeVerifier
            });

            const res = await fetch(ctx.tokenEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`äº¤æ› Token å¤±æ•—: ${res.status} ${res.statusText} - ${errorText}`);
            }

            const tokenResponse = await res.json();
            sessionStorage.setItem('access_token', tokenResponse.access_token || '');
            sessionStorage.setItem('token_response', JSON.stringify(tokenResponse));
            if (tokenResponse.patient) {
                sessionStorage.setItem('patient_id', tokenResponse.patient);
            }
            return tokenResponse;
        }

        // ç¯„ä¾‹è³‡æ–™
        const sampleData = [
            { date: '2023-08-17T14:14:00', systolic: 138, diastolic: 89 },
            { date: '2023-08-19T14:08:00', systolic: 145, diastolic: 97 },
            { date: '2023-08-21T14:07:00', systolic: 136, diastolic: 80 },
            { date: '2023-08-25T14:07:00', systolic: 138, diastolic: 98 },
            { date: '2023-08-26T17:06:00', systolic: 140, diastolic: 89 }
        ];

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // æª¢æŸ¥æˆæ¬Šç‹€æ…‹
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                if (error) {
                    throw new Error(`æˆæ¬Šå¤±æ•—: ${urlParams.get('error_description') || error}`);
                }

                const ctx = getAuthContext();
                fhirBaseUrl = ctx.iss;
                accessToken = sessionStorage.getItem('access_token');
                patientId = sessionStorage.getItem('patient_id');

                if (code) {
                    if (!state || state !== ctx.state) {
                        throw new Error('State é©—è­‰å¤±æ•—ï¼Œå¯èƒ½æ˜¯æˆæ¬Šæµç¨‹ä¸å®Œæ•´æˆ–è¢«æ””æˆª');
                    }

                    const tokenResponse = await exchangeToken(code);
                    accessToken = tokenResponse.access_token;
                    patientId = tokenResponse.patient || sessionStorage.getItem('patient_id');

                    // æ¸…é™¤ URL ä¸Šçš„ code/state
                    const cleanUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }

                if (!accessToken || !fhirBaseUrl) {
                    showNoDataMessage('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                    return;
                }

                if (!patientId) {
                    throw new Error('æˆæ¬Šå®Œæˆä½†æ²’æœ‰å–å¾—ç—…äºº IDï¼Œè«‹ç¢ºèª scope åŒ…å« launch/patient ä¸¦å®Œæˆç—…äººé¸æ“‡');
                }

                // è¼‰å…¥è¡€å£“è³‡æ–™
                await loadBloodPressureData();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showNoDataMessage(error.message || 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æˆæ¬Š');
            }
        });

        // è¼‰å…¥è¡€å£“è³‡æ–™
        async function loadBloodPressureData() {
            try {
                if (!accessToken || !fhirBaseUrl || !patientId) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }

                // æŸ¥è©¢è¡€å£“ Observationï¼ˆLOINC code: 85354-9ï¼‰
                const res = await authorizedFetch(`${fhirBaseUrl}/Observation?subject=Patient/${patientId}&code=85354-9`);
                if (!res.ok) {
                    throw new Error(`è®€å– Observation å¤±æ•—: ${res.status} ${res.statusText}`);
                }
                const observations = await res.json();

                const bpData = parseObservations(observations);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›æ•¸æ“š
                if (bpData.length === 0) {
                    showNoDataMessage();
                    return;
                }
                
                renderChart(bpData);
                renderDistributionChart(bpData);
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                showNoDataMessage(error.message);
            }
        }

        function parseObservations(observations) {
            const entries = observations.entry || [];
            return entries.map(entry => {
                const obs = entry.resource;
                const systolic = obs.component?.find(c => c.code?.coding?.[0]?.code === '8480-6')?.valueQuantity?.value;
                const diastolic = obs.component?.find(c => c.code?.coding?.[0]?.code === '8462-4')?.valueQuantity?.value;
                return {
                    date: obs.effectiveDateTime,
                    systolic: systolic,
                    diastolic: diastolic
                };
            }).filter(d => d.systolic && d.diastolic)
              .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function showNoDataMessage(errorMsg = null) {
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="chart-title">è¡€å£“è¶¨å‹¢åœ–</div>
                    <div style="padding: 40px; text-align: center; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                        <h3 style="color: #495057; margin-bottom: 10px;">ç›®å‰æ²’æœ‰è¡€å£“æ•¸æ“š</h3>
                        <p style="margin-bottom: 5px;">æ­¤ç—…äººçš„è¡€å£“æ•¸æ“šå°šæœªä¸Šå‚³åˆ° FHIR ä¼ºæœå™¨ã€‚</p>
                        ${errorMsg ? `<p style="color: #dc3545; font-size: 14px; margin-top: 10px;">éŒ¯èª¤ï¼š${errorMsg}</p>` : ''}
                        <p style="margin-top: 20px; font-size: 14px; color: #856404;">
                            è«‹å…ˆä¸Šå‚³è¡€å£“æ•¸æ“šï¼Œæˆ–ç¢ºèªç—…äºº ID æ˜¯å¦æ­£ç¢ºã€‚
                        </p>
                    </div>
                `;
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('bpChart').getContext('2d');
            
            if (bpChart) {
                bpChart.destroy();
            }

            bpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString('zh-TW')),
                    datasets: [
                        {
                            label: 'æ”¶ç¸®å£“ (mmHg)',
                            data: data.map(d => d.systolic),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'èˆ’å¼µå£“ (mmHg)',
                            data: data.map(d => d.diastolic),
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 70,
                            max: 150
                        }
                    }
                }
            });

        }

        // æ¸²æŸ“åˆ†å¸ƒåœ–
        function renderDistributionChart(data) {
            const distCtx = document.getElementById('bpDistributionChart').getContext('2d');
            if (distributionChart) {
                distributionChart.destroy();
            }

            distributionChart = new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: ['æ­£å¸¸', 'åé«˜', 'é«˜'],
                    datasets: [{
                        label: 'è¡€å£“åˆ†å¸ƒ',
                        data: calculateDistribution(data),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function calculateDistribution(data) {
            let normal = 0, high = 0, veryHigh = 0;
            data.forEach(d => {
                if (d.systolic >= 140 || d.diastolic >= 90) {
                    veryHigh++;
                } else if (d.systolic >= 130 || d.diastolic >= 85) {
                    high++;
                } else {
                    normal++;
                }
            });
            return [normal, high, veryHigh];
        }
    </script>
</body>
</html>
