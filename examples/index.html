<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>888 é•·ç…§ SDK - ä¸»ç¨‹å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        .nav {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            background-color: #f8f9fa;
            color: #495057;
        }
        .nav button:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }
        .nav button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .content-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .content-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
        }
        .status.error {
            background-color: #fee;
            border-left-color: #e74c3c;
        }
        .status.success {
            background-color: #efe;
            border-left-color: #27ae60;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        button.export-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        button.export-btn:hover {
            background-color: #218838;
        }
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .info-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ 888 é•·ç…§ SDK - ä¸»ç¨‹å¼</h1>
        <div class="subtitle">æŸ¥çœ‹è³‡æ–™ | åˆ†æ | åŒ¯å‡º</div>
    </div>

    <div class="nav">
        <button id="btnPatient" onclick="showSection('patient')" class="active">ğŸ‘¤ ç—…äººè³‡æ–™</button>
        <button id="btnObservations" onclick="showSection('observations')">ğŸ“Š å¥åº·è¨˜éŒ„</button>
        <button id="btnAnalysis" onclick="showSection('analysis')">ğŸ“ˆ æ•¸æ“šåˆ†æ</button>
        <button id="btnExport" onclick="showSection('export')">ğŸ’¾ åŒ¯å‡ºè³‡æ–™</button>
        <button id="btnLogout" onclick="handleLogout()" style="margin-left: auto; background-color: #dc3545; color: white;">ğŸšª ç™»å‡º</button>
    </div>

    <div class="container">
        <!-- ç—…äººè³‡æ–™å€å¡Š -->
        <div id="section-patient" class="content-section active">
            <h2>ğŸ‘¤ ç—…äººåŸºæœ¬è³‡æ–™</h2>
            <div id="patient-status" class="status">æ­£åœ¨è¼‰å…¥ç—…äººè³‡æ–™...</div>
            <div id="patient-content"></div>
        </div>

        <!-- å¥åº·è¨˜éŒ„å€å¡Š -->
        <div id="section-observations" class="content-section">
            <h2>ğŸ“Š å¥åº·è¨˜éŒ„ (Observations)</h2>
            <div id="observations-status" class="status">é»æ“Šä¸Šæ–¹ã€Œå¥åº·è¨˜éŒ„ã€æŒ‰éˆ•è¼‰å…¥è³‡æ–™</div>
            <div id="observations-content"></div>
        </div>

        <!-- æ•¸æ“šåˆ†æå€å¡Š -->
        <div id="section-analysis" class="content-section">
            <h2>ğŸ“ˆ æ•¸æ“šåˆ†æ</h2>
            <div id="analysis-status" class="status">é»æ“Šä¸Šæ–¹ã€Œæ•¸æ“šåˆ†æã€æŒ‰éˆ•é€²è¡Œåˆ†æ</div>
            <div id="analysis-content"></div>
        </div>

        <!-- åŒ¯å‡ºè³‡æ–™å€å¡Š -->
        <div id="section-export" class="content-section">
            <h2>ğŸ’¾ åŒ¯å‡ºè³‡æ–™</h2>
            <div id="export-status" class="status">æº–å‚™åŒ¯å‡ºè³‡æ–™</div>
            <div id="export-content"></div>
        </div>
    </div>

    <!-- è¼‰å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        let accessToken = null;
        let fhirBaseUrl = null;
        let patientId = null;
        let patientData = null;
        let observationsData = null;

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        function updateStatus(sectionId, message, type = 'info') {
            const statusDiv = document.getElementById(`${sectionId}-status`);
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
            }
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showLoading(sectionId) {
            const contentDiv = document.getElementById(`${sectionId}-content`);
            if (contentDiv) {
                contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>æ­£åœ¨è¼‰å…¥è³‡æ–™...</div></div>';
            }
        }

        function getAuthContext() {
            return {
                iss: sessionStorage.getItem('oauth_iss'),
                clientId: sessionStorage.getItem('oauth_client_id'),
                redirectUri: sessionStorage.getItem('oauth_redirect_uri'),
                scope: sessionStorage.getItem('oauth_scope'),
                tokenEndpoint: sessionStorage.getItem('oauth_token_endpoint'),
                state: sessionStorage.getItem('oauth_state'),
                codeVerifier: sessionStorage.getItem('oauth_code_verifier')
            };
        }

        async function authorizedFetch(url, options = {}) {
            if (!accessToken) {
                throw new Error('ç¼ºå°‘ Access Tokenï¼Œè«‹é‡æ–°æˆæ¬Š');
            }
            const headers = {
                Accept: 'application/fhir+json',
                Authorization: `Bearer ${accessToken}`,
                ...(options.headers || {})
            };
            return fetch(url, { ...options, headers });
        }

        async function exchangeToken(code) {
            const ctx = getAuthContext();
            if (!ctx.tokenEndpoint || !ctx.clientId || !ctx.redirectUri || !ctx.codeVerifier) {
                throw new Error('æˆæ¬Šä¸Šä¸‹æ–‡ä¸å®Œæ•´ï¼Œè«‹é‡æ–°å¾ launch.html é–‹å§‹');
            }

            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: ctx.redirectUri,
                client_id: ctx.clientId,
                code_verifier: ctx.codeVerifier
            });

            const res = await fetch(ctx.tokenEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`äº¤æ› Token å¤±æ•—: ${res.status} ${res.statusText} - ${errorText}`);
            }

            const tokenResponse = await res.json();
            sessionStorage.setItem('access_token', tokenResponse.access_token || '');
            sessionStorage.setItem('token_response', JSON.stringify(tokenResponse));
            if (tokenResponse.patient) {
                sessionStorage.setItem('patient_id', tokenResponse.patient);
            }
            return tokenResponse;
        }

        // åˆ‡æ›å€å¡Šé¡¯ç¤º - å¿…é ˆåœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šç¾©ï¼Œä¾› HTML onclick èª¿ç”¨
        window.showSection = function(section) {
            // éš±è—æ‰€æœ‰å€å¡Š
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            // é¡¯ç¤ºé¸ä¸­çš„å€å¡Š
            const sectionEl = document.getElementById(`section-${section}`);
            const btnId = `btn${section.charAt(0).toUpperCase() + section.slice(1)}`;
            const btnEl = document.getElementById(btnId);
            
            if (sectionEl) sectionEl.classList.add('active');
            if (btnEl) btnEl.classList.add('active');

            // æ ¹æ“šå€å¡Šè¼‰å…¥å°æ‡‰è³‡æ–™
            if (section === 'patient' && !patientData) {
                loadPatientData();
            } else if (section === 'observations' && !observationsData) {
                loadObservations();
            } else if (section === 'analysis' && observationsData) {
                showAnalysis();
            } else if (section === 'export') {
                showExportOptions();
            }
        };

        // è¼‰å…¥ç—…äººè³‡æ–™
        async function loadPatientData() {
            try {
                showLoading('patient');
                updateStatus('patient', 'æ­£åœ¨è¼‰å…¥ç—…äººè³‡æ–™...', 'info');

                if (!accessToken || !fhirBaseUrl) {
                    throw new Error('ç¼ºå°‘æˆæ¬Šè³‡è¨Šï¼Œè«‹é‡æ–°æˆæ¬Š');
                }
                if (!patientId) {
                    throw new Error('æˆæ¬Šå›æ‡‰ä¸­æ²’æœ‰ patientï¼Œè«‹ç¢ºèª scope åŒ…å« launch/patient ä¸¦å®Œæˆç—…äººé¸æ“‡');
                }

                console.log('é–‹å§‹è®€å–ç—…äººè³‡æ–™...', { fhirBaseUrl, patientId });
                const res = await authorizedFetch(`${fhirBaseUrl}/Patient/${patientId}`);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`è®€å–ç—…äººè³‡æ–™å¤±æ•—: ${res.status} ${res.statusText} - ${text}`);
                }
                const patient = await res.json();

                if (!patient || !patient.id) {
                    throw new Error('ç„¡æ³•å–å¾—æœ‰æ•ˆçš„ç—…äººè³‡æ–™');
                }

                patientData = { patient, patientId: patient.id };

                // é¡¯ç¤ºç—…äººè³‡è¨Šå¡ç‰‡
                const contentDiv = document.getElementById('patient-content');
                const name = patient.name?.[0] ? 
                    `${patient.name[0].family || ''} ${patient.name[0].given?.join(' ') || ''}`.trim() : 
                    'æœªçŸ¥';
                const gender = patient.gender === 'male' ? 'ç”·' : patient.gender === 'female' ? 'å¥³' : 'æœªçŸ¥';
                const birthDate = patient.birthDate || 'æœªçŸ¥';
                const age = birthDate !== 'æœªçŸ¥' ? 
                    Math.floor((new Date() - new Date(birthDate)) / (365.25 * 24 * 60 * 60 * 1000)) : 'æœªçŸ¥';

                contentDiv.innerHTML = `
                    <div class="patient-info">
                        <div class="info-card">
                            <h3>ç—…äºº ID</h3>
                            <div class="value">${patientId}</div>
                        </div>
                        <div class="info-card">
                            <h3>å§“å</h3>
                            <div class="value">${name}</div>
                        </div>
                        <div class="info-card">
                            <h3>æ€§åˆ¥</h3>
                            <div class="value">${gender}</div>
                        </div>
                        <div class="info-card">
                            <h3>å¹´é½¡</h3>
                            <div class="value">${age} æ­²</div>
                        </div>
                    </div>
                    <h3 style="margin-top: 30px;">å®Œæ•´è³‡æ–™</h3>
                    <pre>${JSON.stringify(patient, null, 2)}</pre>
                `;

                updateStatus('patient', 'âœ“ æˆåŠŸè¼‰å…¥ç—…äººè³‡æ–™', 'success');
            } catch (error) {
                console.error('è¼‰å…¥ç—…äººè³‡æ–™å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack,
                    accessToken: accessToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    fhirBaseUrl: fhirBaseUrl || 'æœªè¨­å®š',
                    patientId: patientId || 'æœªè¨­å®š'
                });
                
                updateStatus('patient', `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                
                const errorHTML = `
                    <div class="status error">
                        <h3>è¼‰å…¥ç—…äººè³‡æ–™å¤±æ•—</h3>
                        <p><strong>éŒ¯èª¤è¨Šæ¯:</strong> ${error.message}</p>
                        <p><strong>å¯èƒ½çš„åŸå› :</strong></p>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li>æˆæ¬Šæœªå®Œæˆæˆ–å·²éæœŸ</li>
                            <li>FHIR Client æœªæ­£ç¢ºåˆå§‹åŒ–</li>
                            <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                            <li>THAS ä¼ºæœå™¨æš«æ™‚ç„¡æ³•å›æ‡‰</li>
                        </ul>
                        <p><strong>å»ºè­°æ“ä½œ:</strong></p>
                        <ol style="margin: 15px 0; padding-left: 20px;">
                            <li>æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°çš„è©³ç´°éŒ¯èª¤è¨Šæ¯</li>
                            <li>ç¢ºèªå·²æ­£ç¢ºå®Œæˆæˆæ¬Šæµç¨‹ï¼ˆç™»å…¥ã€é¸æ“‡ç—…äººã€åŒæ„æˆæ¬Šï¼‰</li>
                            <li>å˜—è©¦é‡æ–°å¾ <a href="./launch.html" style="color: #3498db;">launch.html</a> é–‹å§‹</li>
                        </ol>
                        <button onclick="window.location.href='./launch.html'" 
                                style="margin-top: 15px; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            é‡æ–°æˆæ¬Š
                        </button>
                    </div>
                `;
                document.getElementById('patient-content').innerHTML = errorHTML;
            }
        }

        // è¼‰å…¥å¥åº·è¨˜éŒ„
        async function loadObservations() {
            try {
                showLoading('observations');
                updateStatus('observations', 'æ­£åœ¨è¼‰å…¥å¥åº·è¨˜éŒ„...', 'info');

                if (!accessToken || !fhirBaseUrl || !patientData) {
                    throw new Error('è«‹å…ˆå®Œæˆæˆæ¬Šä¸¦è¼‰å…¥ç—…äººè³‡æ–™');
                }

                const res = await authorizedFetch(`${fhirBaseUrl}/Observation?subject=Patient/${patientData.patientId}`);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`è®€å– Observation å¤±æ•—: ${res.status} ${res.statusText} - ${text}`);
                }
                const observations = await res.json();
                observationsData = observations;

                const contentDiv = document.getElementById('observations-content');
                
                if (!observations.entry || observations.entry.length === 0) {
                    contentDiv.innerHTML = '<div class="status">ç›®å‰æ²’æœ‰å¥åº·è¨˜éŒ„</div>';
                    updateStatus('observations', 'âœ“ è¼‰å…¥å®Œæˆï¼ˆç„¡è¨˜éŒ„ï¼‰', 'success');
                    return;
                }

                // å»ºç«‹è¡¨æ ¼
                let tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸæ™‚é–“</th>
                                <th>é¡å‹</th>
                                <th>æ•¸å€¼</th>
                                <th>å–®ä½</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                observations.entry.forEach(entry => {
                    const obs = entry.resource;
                    const date = obs.effectiveDateTime || obs.meta?.lastUpdated || 'æœªçŸ¥';
                    const code = obs.code?.coding?.[0]?.display || obs.code?.text || 'æœªçŸ¥';
                    const value = obs.valueQuantity?.value || obs.valueString || obs.valueCodeableConcept?.text || 'æœªçŸ¥';
                    const unit = obs.valueQuantity?.unit || '';
                    const status = obs.status || 'æœªçŸ¥';

                    tableHTML += `
                        <tr>
                            <td>${new Date(date).toLocaleString('zh-TW')}</td>
                            <td>${code}</td>
                            <td>${value}</td>
                            <td>${unit}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                contentDiv.innerHTML = tableHTML;

                updateStatus('observations', `âœ“ æˆåŠŸè¼‰å…¥ ${observations.entry.length} ç­†å¥åº·è¨˜éŒ„`, 'success');
            } catch (error) {
                console.error('è¼‰å…¥å¥åº·è¨˜éŒ„å¤±æ•—:', error);
                updateStatus('observations', `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('observations-content').innerHTML = 
                    `<div class="status error">éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        // é¡¯ç¤ºæ•¸æ“šåˆ†æ
        function showAnalysis() {
            if (!observationsData || !observationsData.entry) {
                document.getElementById('analysis-content').innerHTML = 
                    '<div class="status error">è«‹å…ˆè¼‰å…¥å¥åº·è¨˜éŒ„</div>';
                return;
            }

            const contentDiv = document.getElementById('analysis-content');
            
            // åˆ†æè¡€å£“æ•¸æ“š
            const bloodPressureData = observationsData.entry
                .filter(e => {
                    const code = e.resource.code?.coding?.[0]?.code;
                    return code === '85354-9' || code === '85350-7'; // è¡€å£“ç›¸é—œ LOINC codes
                })
                .map(e => {
                    const obs = e.resource;
                    const date = new Date(obs.effectiveDateTime || obs.meta?.lastUpdated);
                    const components = obs.component || [];
                    const systolic = components.find(c => c.code?.coding?.[0]?.code === '8480-6')?.valueQuantity?.value;
                    const diastolic = components.find(c => c.code?.coding?.[0]?.code === '8462-4')?.valueQuantity?.value;
                    return { date, systolic, diastolic };
                })
                .filter(d => d.systolic && d.diastolic)
                .sort((a, b) => a.date - b.date);

            let analysisHTML = '<h3>ğŸ“Š è¡€å£“è¶¨å‹¢åˆ†æ</h3>';
            
            if (bloodPressureData.length > 0) {
                const avgSystolic = bloodPressureData.reduce((sum, d) => sum + d.systolic, 0) / bloodPressureData.length;
                const avgDiastolic = bloodPressureData.reduce((sum, d) => sum + d.diastolic, 0) / bloodPressureData.length;
                const latest = bloodPressureData[bloodPressureData.length - 1];

                analysisHTML += `
                    <div class="patient-info" style="margin: 20px 0;">
                        <div class="info-card">
                            <h3>å¹³å‡æ”¶ç¸®å£“</h3>
                            <div class="value">${avgSystolic.toFixed(1)}</div>
                        </div>
                        <div class="info-card">
                            <h3>å¹³å‡èˆ’å¼µå£“</h3>
                            <div class="value">${avgDiastolic.toFixed(1)}</div>
                        </div>
                        <div class="info-card">
                            <h3>æœ€æ–°æ”¶ç¸®å£“</h3>
                            <div class="value">${latest.systolic}</div>
                        </div>
                        <div class="info-card">
                            <h3>æœ€æ–°èˆ’å¼µå£“</h3>
                            <div class="value">${latest.diastolic}</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="bpChart"></canvas>
                    </div>
                `;

                contentDiv.innerHTML = analysisHTML;

                // ç¹ªè£½åœ–è¡¨
                setTimeout(() => {
                    const ctx = document.getElementById('bpChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: bloodPressureData.map(d => d.date.toLocaleDateString('zh-TW')),
                                datasets: [{
                                    label: 'æ”¶ç¸®å£“',
                                    data: bloodPressureData.map(d => d.systolic),
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    tension: 0.1
                                }, {
                                    label: 'èˆ’å¼µå£“',
                                    data: bloodPressureData.map(d => d.diastolic),
                                    borderColor: 'rgb(54, 162, 235)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'è¡€å£“è¶¨å‹¢åœ–'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        title: {
                                            display: true,
                                            text: 'è¡€å£“ (mmHg)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            } else {
                analysisHTML += '<div class="status">ç›®å‰æ²’æœ‰è¶³å¤ çš„è¡€å£“æ•¸æ“šé€²è¡Œåˆ†æ</div>';
                contentDiv.innerHTML = analysisHTML;
            }

            updateStatus('analysis', 'âœ“ åˆ†æå®Œæˆ', 'success');
        }

        // é¡¯ç¤ºåŒ¯å‡ºé¸é …
        function showExportOptions() {
            const contentDiv = document.getElementById('export-content');
            
            contentDiv.innerHTML = `
                <h3>é¸æ“‡åŒ¯å‡ºæ ¼å¼</h3>
                <div style="margin: 20px 0;">
                    <button class="export-btn" onclick="exportData('json')">ğŸ“„ åŒ¯å‡ºç‚º JSON</button>
                    <button class="export-btn" onclick="exportData('csv')">ğŸ“Š åŒ¯å‡ºç‚º CSV</button>
                    <button class="export-btn" onclick="exportData('pdf')">ğŸ“‘ åŒ¯å‡ºç‚º PDF å ±å‘Š</button>
                </div>
                <div id="export-result" style="margin-top: 20px;"></div>
            `;
        }

        // åŒ¯å‡ºè³‡æ–™
        window.exportData = function(format) {
            const resultDiv = document.getElementById('export-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><div>æ­£åœ¨åŒ¯å‡ºè³‡æ–™...</div></div>';

            try {
                let data = {};
                if (patientData) data.patient = patientData.patient;
                if (observationsData) data.observations = observationsData;

                if (format === 'json') {
                    const jsonStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `patient-data-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    resultDiv.innerHTML = '<div class="status success">âœ“ JSON æª”æ¡ˆå·²ä¸‹è¼‰</div>';
                } else if (format === 'csv') {
                    // ç°¡åŒ–çš„ CSV åŒ¯å‡ºï¼ˆåƒ…åŒ¯å‡º Observationsï¼‰
                    if (observationsData && observationsData.entry) {
                        let csv = 'æ—¥æœŸæ™‚é–“,é¡å‹,æ•¸å€¼,å–®ä½,ç‹€æ…‹\n';
                        observationsData.entry.forEach(entry => {
                            const obs = entry.resource;
                            const date = obs.effectiveDateTime || obs.meta?.lastUpdated || '';
                            const code = obs.code?.coding?.[0]?.display || obs.code?.text || '';
                            const value = obs.valueQuantity?.value || obs.valueString || '';
                            const unit = obs.valueQuantity?.unit || '';
                            const status = obs.status || '';
                            csv += `"${date}","${code}","${value}","${unit}","${status}"\n`;
                        });
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `observations-${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                        resultDiv.innerHTML = '<div class="status success">âœ“ CSV æª”æ¡ˆå·²ä¸‹è¼‰</div>';
                    } else {
                        resultDiv.innerHTML = '<div class="status error">æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º</div>';
                    }
                } else if (format === 'pdf') {
                    resultDiv.innerHTML = '<div class="status">PDF åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹ä½¿ç”¨ JSON æˆ– CSV æ ¼å¼</div>';
                }
            } catch (error) {
                console.error('åŒ¯å‡ºå¤±æ•—:', error);
                resultDiv.innerHTML = `<div class="status error">åŒ¯å‡ºå¤±æ•—: ${error.message}</div>`;
            }
        };

        // ç™»å‡º
        window.handleLogout = async function() {
            try {
                if (fhirClient) {
                    await fhirClient.logout();
                }
                // æ¸…é™¤ sessionStorage
                sessionStorage.clear();
                // å°å‘ launch.html
                window.location.href = './launch.html';
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                // å³ä½¿ç™»å‡ºå¤±æ•—ï¼Œä¹Ÿå°å‘ launch.html
                window.location.href = './launch.html';
            }
        };

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                updateStatus('patient', 'æ­£åœ¨åˆå§‹åŒ–...', 'info');

                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                if (error) {
                    const errorDesc = urlParams.get('error_description') || error;
                    throw new Error(`æˆæ¬Šå¤±æ•—: ${errorDesc}`);
                }

                const ctx = getAuthContext();
                fhirBaseUrl = ctx.iss;
                accessToken = sessionStorage.getItem('access_token');
                patientId = sessionStorage.getItem('patient_id');

                if (code) {
                    if (!state || state !== ctx.state) {
                        throw new Error('State é©—è­‰å¤±æ•—ï¼Œå¯èƒ½æ˜¯æˆæ¬Šæµç¨‹ä¸å®Œæ•´æˆ–è¢«æ””æˆª');
                    }

                    updateStatus('patient', 'æ­£åœ¨äº¤æ› Access Token...', 'info');
                    const tokenResponse = await exchangeToken(code);
                    accessToken = tokenResponse.access_token;
                    patientId = tokenResponse.patient || sessionStorage.getItem('patient_id');

                    // æ¸…é™¤ URL ä¸Šçš„ code/state
                    const cleanUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }

                if (!accessToken || !fhirBaseUrl) {
                    updateStatus('patient', 'âŒ éŒ¯èª¤ï¼šç¼ºå°‘æˆæ¬Šæ†‘è­‰ã€‚è«‹å…ˆå¾ launch.html å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ã€‚', 'error');
                    document.getElementById('patient-content').innerHTML = `
                        <div class="status error">
                            <h3>éŒ¯èª¤ï¼šç¼ºå°‘å®‰å…¨æ†‘è­‰</h3>
                            <p>æ­¤æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ SMART on FHIR æ¨™æº–å”è­°ï¼Œéœ€è¦ç¶“éæˆæ¬Šæµç¨‹æ‰èƒ½å­˜å–è³‡æ–™ã€‚</p>
                            <p>è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š</p>
                            <ol style="margin: 15px 0; padding-left: 20px;">
                                <li>é–‹å•Ÿ <a href="./launch.html" style="color: #3498db;">launch.html</a> é€²è¡Œæˆæ¬Š</li>
                                <li>å®Œæˆèº«åˆ†é©—è­‰å’Œç—…äººé¸æ“‡</li>
                                <li>ç³»çµ±æœƒè‡ªå‹•å°å‘æ­¤é é¢</li>
                            </ol>
                            <button onclick="window.location.href='./launch.html'" 
                                    style="margin-top: 15px; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                å‰å¾€ launch.html
                            </button>
                        </div>
                    `;
                    return;
                }

                if (!patientId) {
                    throw new Error('æˆæ¬Šå®Œæˆä½†æ²’æœ‰å–å¾—ç—…äºº IDï¼Œè«‹ç¢ºèª scope åŒ…å« launch/patient ä¸¦å®Œæˆç—…äººé¸æ“‡');
                }

                updateStatus('patient', 'âœ“ åˆå§‹åŒ–æˆåŠŸï¼Œæ­£åœ¨è¼‰å…¥ç—…äººè³‡æ–™...', 'success');
                await loadPatientData();

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                updateStatus('patient', `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('patient-content').innerHTML = `
                    <div class="status error">
                        <h3>åˆå§‹åŒ–å¤±æ•—</h3>
                        <p>${error.message}</p>
                        <p>è«‹ç¢ºèªï¼š</p>
                        <ul style="margin: 15px 0; padding-left: 20px;">
                            <li>å·²æ­£ç¢ºå®Œæˆæˆæ¬Šæµç¨‹</li>
                            <li>æˆæ¬Š token å°šæœªéæœŸ</li>
                            <li>ç¶²è·¯é€£ç·šæ­£å¸¸</li>
                        </ul>
                        <button onclick="window.location.href='./launch.html'" 
                                style="margin-top: 15px; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            é‡æ–°æˆæ¬Š
                        </button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
